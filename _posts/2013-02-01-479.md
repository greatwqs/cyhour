---
title: WordPress Ajax 评论提交
author: 大肥羊
layout: post
permalink: /479.html
categories:
  - 大肥羊转载
tags:
  - wordpress
---
与 <a href="https://cyhour.com/wordpress-new-ajax-comments.html" target="_blank">WordPress新版ajax评论</a> 此文方法类似，但速度会稍快点。代码最后修改时间为：2014-11-21.  


  
下面是实现方法：

### 一、将下面代码保存为 ajax-comment.js ，并将文件放至主题文件夹的 js 路径下面。

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"><span style="color:#000">jQuery</span>(<span style="color:#000">document</span>).<span style="color:#000">ready</span>(<span style="color:#708">function</span>(<span style="color:#00f">jQuery</span>) {<br />	<span style="color:#708">var</span> <span style="color:#00f">$commentform</span> = <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#commentform'</span>),<br />	<span style="color:#00f">$comments</span> = <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#comments-title'</span>),<br />	<span style="color:#00f">$cancel</span> = <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#cancel-comment-reply-link'</span>),<br />	<span style="color:#00f">cancel_text</span> = <span style="color:#000-2">$cancel</span>.<span style="color:#000">text</span>();<br />	<span style="color:#000-2">jQuery</span>(<span style="color:#000">document</span>).<span style="color:#000">on</span>(<span style="color:#a11">"submit"</span>, <span style="color:#a11">"#commentform"</span>,<br />	<span style="color:#708">function</span>() {<br />		<span style="color:#000-2">jQuery</span>.<span style="color:#000">ajax</span>({<br />			<span style="color:#000">url</span>: <span style="color:#000">ajaxcomment</span>.<span style="color:#000">ajax_url</span>,<br />			<span style="color:#000">data</span>: <span style="color:#000-2">jQuery</span>(<span style="color:#000-2">this</span>).<span style="color:#000">serialize</span>() + <span style="color:#a11">"&action=ajax_comment"</span>,<br />			<span style="color:#000">type</span>: <span style="color:#000-2">jQuery</span>(<span style="color:#000-2">this</span>).<span style="color:#000">attr</span>(<span style="color:#a11">'method'</span>),<br />			<span style="color:#000">beforeSend</span>:<span style="color:#000">addComment</span>.<span style="color:#000">createButterbar</span>(<span style="color:#a11">"提交中...."</span>),<br />			<span style="color:#000">error</span>: <span style="color:#708">function</span>(<span style="color:#00f">request</span>) {<br />				<span style="color:#708">var</span> <span style="color:#00f">t</span> = <span style="color:#000">addComment</span>;<br />				<span style="color:#000-2">t</span>.<span style="color:#000">createButterbar</span>(<span style="color:#000-2">request</span>.<span style="color:#000">responseText</span>);<br />			},<br />			<span style="color:#000">success</span>: <span style="color:#708">function</span>(<span style="color:#00f">data</span>) {<br />				<span style="color:#000-2">jQuery</span>(<span style="color:#a11">'textarea'</span>).<span style="color:#000">each</span>(<span style="color:#708">function</span>() {<br />					<span style="color:#000-2">this</span>.<span style="color:#000">value</span> = <span style="color:#a11">''</span><br />				});<br />				<span style="color:#708">var</span> <span style="color:#00f">t</span> = <span style="color:#000">addComment</span>,<br />				<span style="color:#00f">cancel</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'cancel-comment-reply-link'</span>),<br />				<span style="color:#00f">temp</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'wp-temp-form-div'</span>),<br />				<span style="color:#00f">respond</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#000-2">t</span>.<span style="color:#000">respondId</span>),<br />				<span style="color:#00f">post</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_post_ID'</span>).<span style="color:#000">value</span>,<br />				<span style="color:#00f">parent</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_parent'</span>).<span style="color:#000">value</span>;<br />				<span style="color:#708">if</span> (<span style="color:#000-2">parent</span> != <span style="color:#a11">'0'</span>) {<br />					<span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#respond'</span>).<span style="color:#000">before</span>(<span style="color:#a11">'&lt;ul class="children"&gt;'</span> + <span style="color:#000-2">data</span> + <span style="color:#a11">'&lt;/ul&gt;'</span>);<br />				} <span style="color:#708">else</span> {<br />					<span style="color:#000-2">jQuery</span>(<span style="color:#a11">'.commentlist'</span>).<span style="color:#000">append</span>(<span style="color:#000-2">data</span>);<span style="color:#a50">// 此处修改为你的主题评论包裹 class 或者 id 名称</span><br />				}<br />				<span style="color:#000-2">t</span>.<span style="color:#000">createButterbar</span>(<span style="color:#a11">"提交成功"</span>);<br />				<span style="color:#000-2">cancel</span>.<span style="color:#000">style</span>.<span style="color:#000">display</span> = <span style="color:#a11">'none'</span>;<br />				<span style="color:#000-2">cancel</span>.<span style="color:#000">onclick</span> = <span style="color:#219">null</span>;<br />				<span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_parent'</span>).<span style="color:#000">value</span> = <span style="color:#a11">'0'</span>;<br />				<span style="color:#708">if</span> (<span style="color:#000-2">temp</span> && <span style="color:#000-2">respond</span>) {<br />					<span style="color:#000-2">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">insertBefore</span>(<span style="color:#000-2">respond</span>, <span style="color:#000-2">temp</span>);<br />					<span style="color:#000-2">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">removeChild</span>(<span style="color:#000-2">temp</span>)<br />				}<br />			}<br />		});<br />		<span style="color:#708">return</span> <span style="color:#219">false</span>;<br />	});<br />	<span style="color:#000">addComment</span> = {<br />		<span style="color:#000">moveForm</span>: <span style="color:#708">function</span>(<span style="color:#00f">commId</span>, <span style="color:#00f">parentId</span>, <span style="color:#00f">respondId</span>) {<br />			<span style="color:#708">var</span> <span style="color:#00f">t</span> = <span style="color:#000-2">this</span>,<br />			<span style="color:#00f">div</span>,<br />			<span style="color:#00f">comm</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#000-2">commId</span>),<br />			<span style="color:#00f">respond</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#000-2">respondId</span>),<br />			<span style="color:#00f">cancel</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'cancel-comment-reply-link'</span>),<br />			<span style="color:#00f">parent</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_parent'</span>),<br />			<span style="color:#00f">post</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_post_ID'</span>);<br />			<span style="color:#000-2">$cancel</span>.<span style="color:#000">text</span>(<span style="color:#000-2">cancel_text</span>);<br />			<span style="color:#000-2">t</span>.<span style="color:#000">respondId</span> = <span style="color:#000-2">respondId</span>;<br />			<span style="color:#708">if</span> (!<span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'wp-temp-form-div'</span>)) {<br />				<span style="color:#000-2">div</span> = <span style="color:#000">document</span>.<span style="color:#000">createElement</span>(<span style="color:#a11">'div'</span>);<br />				<span style="color:#000-2">div</span>.<span style="color:#000">id</span> = <span style="color:#a11">'wp-temp-form-div'</span>;<br />				<span style="color:#000-2">div</span>.<span style="color:#000">style</span>.<span style="color:#000">display</span> = <span style="color:#a11">'none'</span>;<br />				<span style="color:#000-2">respond</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">insertBefore</span>(<span style="color:#000-2">div</span>, <span style="color:#000-2">respond</span>)<br />			} ! <span style="color:#000-2">comm</span> ? (<span style="color:#000">temp</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'wp-temp-form-div'</span>), <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_parent'</span>).<span style="color:#000">value</span> = <span style="color:#a11">'0'</span>, <span style="color:#000">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">insertBefore</span>(<span style="color:#000-2">respond</span>, <span style="color:#000">temp</span>), <span style="color:#000">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">removeChild</span>(<span style="color:#000">temp</span>)) : <span style="color:#000-2">comm</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">insertBefore</span>(<span style="color:#000-2">respond</span>, <span style="color:#000-2">comm</span>.<span style="color:#000">nextSibling</span>);<br />			<span style="color:#000-2">jQuery</span>(<span style="color:#a11">"body"</span>).<span style="color:#000">animate</span>({<br />				<span style="color:#000">scrollTop</span>: <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#respond'</span>).<span style="color:#000">offset</span>().<span style="color:#000">top</span> - <span style="color:#164">180</span><br />			},<br />			<span style="color:#164">400</span>);<br />			<span style="color:#000-2">parent</span>.<span style="color:#000">value</span> = <span style="color:#000-2">parentId</span>;<br />			<span style="color:#000-2">cancel</span>.<span style="color:#000">style</span>.<span style="color:#000">display</span> = <span style="color:#a11">''</span>;<br />			<span style="color:#000-2">cancel</span>.<span style="color:#000">onclick</span> = <span style="color:#708">function</span>() {<br />				<span style="color:#708">var</span> <span style="color:#00f">t</span> = <span style="color:#000">addComment</span>,<br />				<span style="color:#00f">temp</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'wp-temp-form-div'</span>),<br />				<span style="color:#00f">respond</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#000-2">t</span>.<span style="color:#000">respondId</span>);<br />				<span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_parent'</span>).<span style="color:#000">value</span> = <span style="color:#a11">'0'</span>;<br />				<span style="color:#708">if</span> (<span style="color:#000-2">temp</span> && <span style="color:#000-2">respond</span>) {<br />					<span style="color:#000-2">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">insertBefore</span>(<span style="color:#000-2">respond</span>, <span style="color:#000-2">temp</span>);<br />					<span style="color:#000-2">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">removeChild</span>(<span style="color:#000-2">temp</span>);<br />				}<br />				<span style="color:#000-2">this</span>.<span style="color:#000">style</span>.<span style="color:#000">display</span> = <span style="color:#a11">'none'</span>;<br />				<span style="color:#000-2">this</span>.<span style="color:#000">onclick</span> = <span style="color:#219">null</span>;<br />				<span style="color:#708">return</span> <span style="color:#219">false</span>;<br />			};<br />			<span style="color:#708">try</span> {<br />				<span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment'</span>).<span style="color:#000">focus</span>();<br />			}<br />			 <span style="color:#708">catch</span>(<span style="color:#00f">e</span>) {}<br />			<span style="color:#708">return</span> <span style="color:#219">false</span>;<br />		},<br />		<span style="color:#000">I</span>: <span style="color:#708">function</span>(<span style="color:#00f">e</span>) {<br />			<span style="color:#708">return</span> <span style="color:#000">document</span>.<span style="color:#000">getElementById</span>(<span style="color:#000-2">e</span>);<br />		},<br />		<span style="color:#000">clearButterbar</span>: <span style="color:#708">function</span>(<span style="color:#00f">e</span>) {<br />			<span style="color:#708">if</span> (<span style="color:#000-2">jQuery</span>(<span style="color:#a11">".butterBar"</span>).<span style="color:#000">length</span> &gt; <span style="color:#164"></span>) {<br />				<span style="color:#000-2">jQuery</span>(<span style="color:#a11">".butterBar"</span>).<span style="color:#000">remove</span>();<br />			}<br />		},<br />		<span style="color:#000">createButterbar</span>: <span style="color:#708">function</span>(<span style="color:#00f">message</span>) {<br />			<span style="color:#708">var</span> <span style="color:#00f">t</span> = <span style="color:#000-2">this</span>;<br />			<span style="color:#000-2">t</span>.<span style="color:#000">clearButterbar</span>();<br />			<span style="color:#000-2">jQuery</span>(<span style="color:#a11">"body"</span>).<span style="color:#000">append</span>(<span style="color:#a11">'&lt;div class="butterBar butterBar--center"&gt;&lt;p class="butterBar-message"&gt;'</span> + <span style="color:#000-2">message</span> + <span style="color:#a11">'&lt;/p&gt;&lt;/div&gt;'</span>);<br />			<span style="color:#000">setTimeout</span>(<span style="color:#a11">"jQuery('.butterBar').remove()"</span>, <span style="color:#164">3000</span>);<br />		}<br />	};<br />});</pre>

<span style = "color:red;">注意：</span>需根据你的主题修改 <span style = "color:blue;">// 此处修改为你的主题评论包裹 class 或者 id 名称</span> 此行代码。

### 二、将下面的代码copy至主题的functions.php。

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">function ajax_comment_scripts(){<br />    if ( is_singular() <span style="color:#219">&& comments_open() && get_option( 'thread_comments' ) ) {</span><br />        wp_enqueue_script( 'ajax-comment', get_template_directory_uri() . '/js/ajax-comment.js' );<br />        wp_localize_script( 'ajax-comment', 'ajaxcomment', array('ajax_url'   =&gt; admin_url('admin-ajax.php')) );<br />    }<br />}<br />add_action( 'wp_enqueue_scripts', 'ajax_comment_scripts' );<br /><br />add_action('wp_ajax_nopriv_ajax_comment', 'ajax_comment_callback');<br />add_action('wp_ajax_ajax_comment', 'ajax_comment_callback');<br />function ajax_comment_callback(){<br />    global $wpdb;<br />    $comment_post_ID = isset($_POST['comment_post_ID']) ? (int) $_POST['comment_post_ID'] : 0;<br />    $post = get_post($comment_post_ID);<br />    $post_author = $post-&gt;post_author;<br />    if ( empty($post-&gt;comment_status) ) {<br />        do_action('comment_id_not_found', $comment_post_ID);<br />        ajax_comment_err('Invalid comment status.');<br />    }<br />    $status = get_post_status($post);<br />    $status_obj = get_post_status_object($status);<br />    if ( !comments_open($comment_post_ID) ) {<br />        do_action('comment_closed', $comment_post_ID);<br />        ajax_comment_err('Sorry, comments are closed for this item.');<br />    } elseif ( 'trash' == $status ) {<br />        do_action('comment_on_trash', $comment_post_ID);<br />        ajax_comment_err('Invalid comment status.');<br />    } elseif ( !$status_obj-&gt;public <span style="color:#219">&& !$status_obj-&gt;private ) {</span><br />        do_action('comment_on_draft', $comment_post_ID);<br />        ajax_comment_err('Invalid comment status.');<br />    } elseif ( post_password_required($comment_post_ID) ) {<br />        do_action('comment_on_password_protected', $comment_post_ID);<br />        ajax_comment_err('Password Protected');<br />    } else {<br />        do_action('pre_comment_on_post', $comment_post_ID);<br />    }<br />    $comment_author       = ( isset($_POST['author']) )  ? trim(strip_tags($_POST['author'])) : null;<br />    $comment_author_email = ( isset($_POST['email']) )   ? trim($_POST['email']) : null;<br />    $comment_author_url   = ( isset($_POST['url']) )     ? trim($_POST['url']) : null;<br />    $comment_content      = ( isset($_POST['comment']) ) ? trim($_POST['comment']) : null;<br />    $user = wp_get_current_user();<br />    if ( $user-&gt;exists() ) {<br />        if ( empty( $user-&gt;display_name ) )<br />            $user-&gt;display_name=$user-&gt;user_login;<br />        $comment_author       = esc_sql($user-&gt;display_name);<br />        $comment_author_email = esc_sql($user-&gt;user_email);<br />        $comment_author_url   = esc_sql($user-&gt;user_url);<br />        $user_ID              = esc_sql($user-&gt;ID);<br />        if ( current_user_can('unfiltered_html') ) {<br />            if ( wp_create_nonce('unfiltered-html-comment_' . $comment_post_ID) != $_POST['_wp_unfiltered_html_comment'] ) {<br />                kses_remove_filters();<br />                kses_init_filters();<br />            }<br />        }<br />    } else {<br />        if ( get_option('comment_registration') || 'private' == $status )<br />            ajax_comment_err('Sorry, you must be logged in to post a comment.');<br />    }<br />    $comment_type = '';<br />    if ( get_option('require_name_email') <span style="color:#219">&& !$user-&gt;exists() ) {</span><br />        if ( 6 &gt; strlen($comment_author_email) || '' == $comment_author )<br />            ajax_comment_err( 'Error: 请填写昵称以及邮箱.' );<br />        elseif ( !is_email($comment_author_email))<br />            ajax_comment_err( 'Error: 请输入一个有效的电子邮箱地址.' );<br />    }<br />    if ( '' == $comment_content )<br />        ajax_comment_err( 'Error: please type a comment.' );<br />    $dupe = "SELECT comment_ID FROM $wpdb-&gt;comments WHERE comment_post_ID = '$comment_post_ID' AND ( comment_author = '$comment_author' ";<br />    if ( $comment_author_email ) $dupe .= "OR comment_author_email = '$comment_author_email' ";<br />    $dupe .= ") AND comment_content = '$comment_content' LIMIT 1";<br />    if ( $wpdb-&gt;get_var($dupe) ) {<br />        ajax_comment_err('Duplicate comment detected; it looks as though you<span style="color:#219">&#8217;</span>ve already said that!');<br />    }<br />    if ( $lasttime = $wpdb-&gt;get_var( $wpdb-&gt;prepare("SELECT comment_date_gmt FROM $wpdb-&gt;comments WHERE comment_author = %s ORDER BY comment_date DESC LIMIT 1", $comment_author) ) ) {<br />        $time_lastcomment = mysql2date('U', $lasttime, false);<br />        $time_newcomment  = mysql2date('U', current_time('mysql', 1), false);<br />        $flood_die = apply_filters('comment_flood_filter', false, $time_lastcomment, $time_newcomment);<br />        if ( $flood_die ) {<br />            ajax_comment_err('You are posting comments too quickly.  Slow down.');<br />        }<br />    }<br />    $comment_parent = isset($_POST['comment_parent']) ? absint($_POST['comment_parent']) : 0;<br />    $commentdata = compact('comment_post_ID', 'comment_author', 'comment_author_email', 'comment_author_url', 'comment_content', 'comment_type', 'comment_parent', 'user_ID');<br /><br />    $comment_id = wp_new_comment( $commentdata );<br /><br />    $comment = get_comment($comment_id);<br />    do_action('set_comment_cookies', $comment, $user);<br />    $comment_depth = 1;<br />    $tmp_c = $comment;<br />    while($tmp_c-&gt;comment_parent != 0){<br />        $comment_depth++;<br />        $tmp_c = get_comment($tmp_c-&gt;comment_parent);<br />    }<br />    $GLOBALS['comment'] = $comment;<br />    ?&gt;<br />    <span style="color:#a50">&lt;!-- Your comments here  edit start //这里修改成你的评论结构 --&gt;</span><br />    <span style="color:#170">&lt;li</span> <span style="color:#00c">&lt;</span><span style="color:#00c">?php</span> <span style="color:#00c">comment_class();</span> <span style="color:#00c">?</span><span style="color:#170">&gt;</span> id="li-comment-<span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">comment_ID</span>(); <span style="color:#555">?&gt;</span>"&gt;<br />        <span style="color:#170">&lt;article</span> <span style="color:#00c">id</span>=<span style="color:#a11">"comment-&lt;?php comment_ID(); ?&gt;"</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment"</span><span style="color:#170">&gt;</span><br />            <span style="color:#170">&lt;footer</span><span style="color:#170">&gt;</span><br />                <span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment-author vcard"</span><span style="color:#170">&gt;</span><br />                    <span style="color:#555">&lt;?php</span> <span style="color:#708">echo</span> <span style="color:#@cm-word">get_avatar</span>( <span style="color:#000-2">$comment</span>, <span style="color:#164">40</span> ); <span style="color:#555">?&gt;</span><br />                    <span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">printf</span>( <span style="color:#@cm-word">__</span>( <span style="color:#a11">'%s'</span>, <span style="color:#a11">'publish'</span> ), <span style="color:#@cm-word">sprintf</span>( <span style="color:#a11">'&lt;cite class="fn"&gt;%s&lt;/cite&gt;'</span>, <span style="color:#@cm-word">get_comment_author_link</span>() ) ); <span style="color:#555">?&gt;</span><br />                    <span style="color:#170">&lt;span</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment-meta commentmetadata"</span><span style="color:#170">&gt;</span><br />                        <span style="color:#170">&lt;time</span> <span style="color:#00c">pubdate</span> <span style="color:#00c">datetime</span>=<span style="color:#a11">"&lt;?php comment_time( 'c' ); ?&gt;"</span><span style="color:#170">&gt;</span><br />                        <span style="color:#555">&lt;?php</span><br />                            <span style="color:#a50">/* translators: 1: date, 2: time */</span><br />                            <span style="color:#@cm-word">printf</span>( <span style="color:#@cm-word">__</span>( <span style="color:#a11">'%1$s %2$s'</span>, <span style="color:#a11">'publish'</span> ), <span style="color:#@cm-word">get_comment_date</span>(), <span style="color:#@cm-word">get_comment_time</span>() ); <span style="color:#555">?&gt;</span><br />                        <span style="color:#170">&lt;/time</span><span style="color:#170">&gt;</span><br />                        <span style="color:#170">&lt;a</span> <span style="color:#00c">href</span>=<span style="color:#a11">"&lt;?php echo esc_url( get_comment_link( $comment-&gt;comment_ID ) ); ?&gt;"</span><span style="color:#170">&gt;</span>#<span style="color:#170">&lt;/a</span><span style="color:#170">&gt;</span><br />                    <span style="color:#170">&lt;/span</span><span style="color:#170">&gt;</span><br />                <span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><span style="color:#a50">&lt;!-- .comment-author .vcard --&gt;</span><br />                <span style="color:#555">&lt;?php</span> <span style="color:#708">if</span> ( <span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_approved</span> <span style="color:#000">==</span> <span style="color:#a11">'0'</span> ) : <span style="color:#555">?&gt;</span><br />                    <span style="color:#170">&lt;em</span><span style="color:#170">&gt;</span><span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">_e</span>( <span style="color:#a11">'Your comment is awaiting moderation.'</span>, <span style="color:#a11">'publish'</span> ); <span style="color:#555">?&gt;</span><span style="color:#170">&lt;/em</span><span style="color:#170">&gt;</span><br />                    <span style="color:#170">&lt;br</span> <span style="color:#170">/&gt;</span><br />                <span style="color:#555">&lt;?php</span> <span style="color:#708">endif</span>; <span style="color:#555">?&gt;</span> <br />            <span style="color:#170">&lt;/footer</span><span style="color:#170">&gt;</span><br />            <span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment-content"</span><span style="color:#170">&gt;</span><span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">comment_text</span>(); <span style="color:#555">?&gt;</span><span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br />        <span style="color:#170">&lt;/article</span><span style="color:#170">&gt;</span><span style="color:#a50">&lt;!-- #comment-## --&gt;</span><br />    <span style="color:#a50">&lt;!-- edit end --&gt;</span><br />    <span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">die</span>();<br />}<br /><span style="color:#708">function</span> <span style="color:#@cm-word">ajax_comment_err</span>(<span style="color:#000-2">$a</span>) {<br />    <span style="color:#@cm-word">header</span>(<span style="color:#a11">'HTTP/1.0 500 Internal Server Error'</span>);<br />    <span style="color:#@cm-word">header</span>(<span style="color:#a11">'Content-Type: text/plain;charset=UTF-8'</span>);<br />    <span style="color:#708">echo</span> <span style="color:#000-2">$a</span>;<br />    <span style="color:#708">exit</span>;<br />}</pre>

<span style = "color:red;">注意：</span>需根据你主题的评论显示输出结构修改（从 <span style = "color:blue;">Your comments here edit start //这里修改成你的评论结构</span> 开始修改）

### 三、参考CSS

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"><span style="color:#a50">/* ajax 提交评论样式 */</span><br />.<span style="color:#170">butterBar</span>{<span style="color:#000">margin-left</span>:<span style="color:#164">36%</span>;<span style="color:#000">max-width</span>:<span style="color:#164">640px</span>;<span style="color:#000">position</span>:<span style="color:#164">fixed</span>;<span style="color:#000">text-align</span>:<span style="color:#164">center</span>;<span style="color:#000">top</span>:<span style="color:#164">50%</span>;<span style="color:#000">width</span>:<span style="color:#164">58%</span>;<span style="color:#000">z-index</span>:<span style="color:#164">800</span>}<br />.<span style="color:#170">butterBar--center</span>{<span style="color:#000">left</span>:<span style="color:#164">50%</span>;<span style="color:#000">margin-left</span>:<span style="color:#164">-320px</span>}<br />.<span style="color:#170">butterBar-message</span>{<span style="color:#000">background</span>:<span style="color:#164">rgba</span><span style="color:#164">(255</span>,<span style="color:#164">255</span>,<span style="color:#164">255</span>,<span style="color:#164">0.8</span><span style="color:#164">)</span>;<span style="color:#000">border-bottom-left-radius</span>:<span style="color:#164">4px</span>;<span style="color:#000">border-bottom-right-radius</span>:<span style="color:#164">4px</span>;<span style="color:#000">box-shadow</span>:<span style="color:#164"></span> <span style="color:#164">1px</span> <span style="color:#164">1px</span> <span style="color:#164">rgba</span><span style="color:#164">(0</span>,<span style="color:#164"></span>,<span style="color:#164"></span>,<span style="color:#164">0.25</span><span style="color:#164">)</span>,<span style="color:#164"></span> <span style="color:#164"></span> <span style="color:#164">1px</span> <span style="color:#164">rgba</span><span style="color:#164">(0</span>,<span style="color:#164"></span>,<span style="color:#164"></span>,<span style="color:#164">0.35</span><span style="color:#164">)</span>;<span style="color:#000">display</span>:<span style="color:#164">inline-block</span>;<span style="color:#000">font-size</span>:<span style="color:#164">14px</span>;<span style="color:#000">margin-bottom</span>:<span style="color:#164"></span>;<span style="color:#000">padding</span>:<span style="color:#164">8px</span> <span style="color:#164">16px</span>;}</pre>

### 四、注意事项

一般做完上面三步就可以正常使用了，但是有些主题文章没有评论的时候不会显示ul或者ol结构，这样就会导致发表文章的第一条评论需要刷新才能正常显示出来。

解决方法，就是要让文章没有评论的时候也显示ul或者ol结构。

比如我的主题评论显示结构原本是这样的：

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"><span style="color:#555">&lt;?php</span> <span style="color:#708">if</span> ( <span style="color:#@cm-word">have_comments</span>() ) : <span style="color:#555">?&gt;</span><br />	<span style="color:#170">&lt;ol</span> <span style="color:#00c">class</span>=<span style="color:#a11">"commentlist"</span><span style="color:#170">&gt;</span><br />		<span style="color:#555">&lt;?php</span><br />			<span style="color:#@cm-word">wp_list_comments</span>( <span style="color:#708">array</span>( <span style="color:#a11">'callback'</span> <span style="color:#000">=&gt;</span> <span style="color:#a11">'publish_comment'</span> ) );<br />		<span style="color:#555">?&gt;</span><br />	<span style="color:#170">&lt;/ol</span><span style="color:#170">&gt;</span><span style="color:#a50">&lt;!-- .commentlist --&gt;</span><br /><span style="color:#555">&lt;?php</span> <span style="color:#708">endif</span>; <span style="color:#a50">// have_comments() ?&gt;</span></pre>

稍作修改变成下面这样就可以了：

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"><span style="color:#555">&lt;?php</span> <span style="color:#708">if</span> ( <span style="color:#@cm-word">comments_open</span>() ) : <span style="color:#555">?&gt;</span><br />	<span style="color:#170">&lt;ol</span> <span style="color:#00c">class</span>=<span style="color:#a11">"commentlist"</span><span style="color:#170">&gt;</span><br />		<span style="color:#555">&lt;?php</span><br />			<span style="color:#@cm-word">wp_list_comments</span>( <span style="color:#708">array</span>( <span style="color:#a11">'callback'</span> <span style="color:#000">=&gt;</span> <span style="color:#a11">'publish_comment'</span> ) );<br />		<span style="color:#555">?&gt;</span><br />	<span style="color:#170">&lt;/ol</span><span style="color:#170">&gt;</span><span style="color:#a50">&lt;!-- .commentlist --&gt;</span><br /><span style="color:#555">&lt;?php</span> <span style="color:#708">endif</span>; <span style="color:#a50">// have_comments() ?&gt;</span></pre>

完！

原文：大发——http://fatesinger.com/59