---
title: WordPress:AJAX版“您最近的评论”
author: 老杨
layout: post
permalink: /369.html
categories:
  - 老杨转载
tags:
  - wordpress
---
**为何用 AJAX 获取评论？**  
1. 每个访客、每个页面都要查询一次数据，MySQL说它受不了 ，它爹（主机）说你肯“受”我也坚持不了  
2. 不是每个访客都会去查询自己的评论，其实真的很少……  


  
先说明：  
1. 代码我随便写的，所以……  
2. 懒得加各种注释，自己Google、百毒  
3. 一般照搬就会工作的……

### 0. 前提

主题已经加载 jQuery 库，如果没有，直接把下面代码扔到主题的 functions.php 的 <?php ?> 里面就会自动加载 WordPress 自带的 jQuery 库了

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">////////Get jQuery<br />if (!is_admin()) {<br />	function my_scripts_method() {<br />		wp_enqueue_script('jquery');<br />	}<br />	add_action('wp_enqueue_scripts', 'my_scripts_method');<br />}</pre>

### 1. HTML，主要根据 Cookie 获取访客的身份（邮箱地址），然后随便放在一个标签里给 JS 获取。

在主题的 footer.php 的 </body> 前加入如下 HTML 代码

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"><span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"guest_comments"</span><span style="color:#170">&gt;</span><br />	<span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"guest_info"</span><span style="color:#170">&gt;</span><br />		<span style="color:#555">&lt;?php</span><br />		<span style="color:#555">$user = wp_get_current_user();</span><br />		<span style="color:#555">if ($user-&gt;exists()) { //这是博主登陆情况</span><br />			<span style="color:#555">echo '您好, &lt;strong&gt;'. $user-&gt;user_login .'&lt;/strong&gt;, &lt;a id="guest_comments" href="#" class="'. $user-&gt;user_email .'" rel="nofollow"&gt;点击这里&lt;/a&gt;可以查看您最近的评论。';</span><br />		<span style="color:#555">} else { //访客有评论过</span><br />			<span style="color:#555">if($_COOKIE["comment_author_" . COOKIEHASH]!=""){</span><br />				<span style="color:#555">echo '您好, &lt;strong&gt;' , $_COOKIE["comment_author_" . COOKIEHASH] , '&lt;/strong&gt;, &lt;a id="guest_comments" href="#" class="'. $_COOKIE["comment_author_email_" . COOKIEHASH] .'" rel="nofollow"&gt;点击这里&lt;/a&gt;可以查看您最近的评论。';</span><br />			<span style="color:#555">} else {</span><br />				<span style="color:#555">echo 'Welcome! o(∩_∩)o';</span><br />			<span style="color:#555">}</span><br />		<span style="color:#555">} ?&gt;</span><br />	<span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br />	<span style="color:#170">&lt;div</span> <span style="color:#00c">id</span>=<span style="color:#a11">"guest_comments_list"</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br />	<span style="color:#170">&lt;a</span> <span style="color:#00c">href</span>=<span style="color:#a11">"#"</span> <span style="color:#00c">id</span>=<span style="color:#a11">"gc_close"</span> <span style="color:#00c">rel</span>=<span style="color:#a11">"nofollow"</span><span style="color:#170">&gt;</span>X<span style="color:#170">&lt;/a</span><span style="color:#170">&gt;</span><br /><span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span></pre>

### 2. AJAX 获取访客评论函数：把下面的“根据访客 cookie 里面的邮箱地址获取某访客的最近12条评论”的函数放到 functions.php

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">//////// Ajax: ajax_guest_comments by zwwooooo | zww.me<br />function ajax_guest_comments(){<br />	if( isset($_GET['action'])<span style="color:#219">&& $_GET['action'] == 'ajax_guest_comments'  ){</span><br />		nocache_headers();<br />		<br />		$gc_userEmail = isset($_GET['gc_userEmail']) ? $_GET['gc_userEmail'] : null;<br />		?&gt;<br />		<br />		<span style="color:#170">&lt;ul</span><span style="color:#170">&gt;</span><br />			<span style="color:#555">&lt;?php</span><br />			<span style="color:#000-2">$announcement</span> <span style="color:#000">=</span> <span style="color:#a11">''</span>;<br />			<span style="color:#000-2">$arg</span> <span style="color:#000">=</span> <span style="color:#708">array</span>(<br />				<span style="color:#a11">'status'</span> <span style="color:#000">=&gt;</span> <span style="color:#a11">'approve'</span>,<br />				<span style="color:#a11">'number'</span> <span style="color:#000">=&gt;</span> <span style="color:#164">12</span>, <span style="color:#a50">//获取的评论数</span><br />				<span style="color:#a11">'post_tyle'</span> <span style="color:#000">=&gt;</span> <span style="color:#a11">'post'</span>,<br />				<span style="color:#a11">'author_email'</span> <span style="color:#000">=&gt;</span> <span style="color:#000-2">$gc_userEmail</span><br />			);<br />			<span style="color:#000-2">$comments</span> <span style="color:#000">=</span> <span style="color:#@cm-word">get_comments</span>(<span style="color:#000-2">$arg</span>);<br />			<span style="color:#000-2">$home_url</span><span style="color:#000">=</span><span style="color:#@cm-word">home_url</span>();<br />			<span style="color:#708">if</span> ( <span style="color:#000">!</span><span style="color:#708">empty</span>(<span style="color:#000-2">$comments</span>) ) {<br />				<span style="color:#708">foreach</span> (<span style="color:#000-2">$comments</span> <span style="color:#708">as</span> <span style="color:#000-2">$comment</span>) {<br />					<span style="color:#000-2">$comment_link</span><span style="color:#000">=</span><span style="color:#@cm-word">get_comment_link</span>( <span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_ID</span>, <span style="color:#708">array</span>(<span style="color:#a11">'type'</span> <span style="color:#000">=&gt;</span> <span style="color:#a11">'all'</span>));<br />					<span style="color:#000-2">$announcement</span> .<span style="color:#000">=</span> <span style="color:#a11">'&lt;li&gt;&lt;span&gt;'</span> . <span style="color:#@cm-word">get_comment_date</span>(<span style="color:#a11">'Y/m/d H:i'</span>,<span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_ID</span>) . <span style="color:#a11">'&lt;/span&gt; &lt;a rel="nofollow" href="'</span>. <span style="color:#000-2">$comment_link</span> .<span style="color:#a11">'" title="on《'</span>. <span style="color:#@cm-word">get_the_title</span>(<span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_post_ID</span>) .<span style="color:#a11">'》"&gt;'</span>. <span style="color:#@cm-word">convert_smilies</span>(<span style="color:#@cm-word">strip_tags</span>(<span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_content</span>)) . <span style="color:#a11">'&lt;/a&gt;&lt;/li&gt;'</span>;<br />				}<br />			}<br />			<span style="color:#708">if</span> ( <span style="color:#708">empty</span>(<span style="color:#000-2">$announcement</span>) ) <span style="color:#000-2">$announcement</span> <span style="color:#000">=</span> <span style="color:#a11">'&lt;li class="reply"&gt;我发现您还没评论过 ^_^&lt;/li&gt;'</span>;<br />			<span style="color:#708">echo</span> <span style="color:#000-2">$announcement</span>;<br />			<span style="color:#555">?&gt;</span><br />		<span style="color:#170">&lt;/ul</span><span style="color:#170">&gt;</span><br />		<br />		<span style="color:#555">&lt;?php</span><br />		<span style="color:#@cm-word">die</span>();<br />	}<br />}<br /><span style="color:#@cm-word">add_action</span>(<span style="color:#a11">'init'</span>, <span style="color:#a11">'ajax_guest_comments'</span>);</pre>

3. jQuery 代码：可以加入到 js 文件，我这里就直接插到 footer.php 了，在 footer.php 的 </body> 前插入如下 jQuery 代码

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">&lt;<span style="color:#000">script</span> <span style="color:#000">type</span>=<span style="color:#a11">"text/javascript"</span>&gt;<br />	<span style="color:#000">jQuery</span>(<span style="color:#000">document</span>).<span style="color:#000">ready</span>(<span style="color:#708">function</span>(<span style="color:#00f">$</span>){<br />		<span style="color:#708">var</span> <span style="color:#00f">$guest_comments_list</span>=<span style="color:#000-2">$</span>(<span style="color:#a11">'#guest_comments_list'</span>),<br />				<span style="color:#00f">$gc_close</span>=<span style="color:#000-2">$</span>(<span style="color:#a11">'#gc_close'</span>);<br />		<span style="color:#000-2">$</span>(<span style="color:#a11">'#guest_comments'</span>).<span style="color:#000">click</span>(<span style="color:#708">function</span>(){<br />			<span style="color:#000">zloading</span>=<span style="color:#164"></span>;<br />			<span style="color:#708">var</span> <span style="color:#00f">$this</span>=<span style="color:#000-2">$</span>(<span style="color:#000-2">this</span>),<br />					<span style="color:#00f">userEmail</span>=<span style="color:#000-2">$this</span>.<span style="color:#000">attr</span>(<span style="color:#a11">'class'</span>);<br />			<span style="color:#708">if</span> (<span style="color:#000-2">userEmail</span>==<span style="color:#a11">'click'</span>) {<br />				<span style="color:#000-2">$guest_comments_list</span>.<span style="color:#000">show</span>();<br />				<span style="color:#000-2">$gc_close</span>.<span style="color:#000">show</span>();<br />				<span style="color:#708">return</span> <span style="color:#219">false</span>;<br />			}<br />			<span style="color:#000-2">$gc_close</span>.<span style="color:#000">show</span>();<br />			<span style="color:#000-2">$guest_comments_list</span>.<span style="color:#000">show</span>();<br />			<span style="color:#000-2">$</span>.<span style="color:#000">get</span>(<span style="color:#a11">'./?action=ajax_guest_comments&gc_userEmail='</span>+<span style="color:#000-2">userEmail</span>,<br />				<span style="color:#708">function</span> (<span style="color:#00f">data</span>) {<br />					<span style="color:#000-2">$this</span>.<span style="color:#000">attr</span>(<span style="color:#a11">'class'</span>,<span style="color:#a11">'click'</span>);<br />					<span style="color:#000-2">$guest_comments_list</span>.<span style="color:#000">html</span>(<span style="color:#000-2">data</span>);<br />				}<br />			);<br />			<span style="color:#708">return</span> <span style="color:#219">false</span>;<br />		});<br />		<span style="color:#000-2">$gc_close</span>.<span style="color:#000">click</span>(<span style="color:#708">function</span>(){<br />			<span style="color:#000-2">$guest_comments_list</span>.<span style="color:#000">hide</span>();<br />			<span style="color:#000-2">$</span>(<span style="color:#000-2">this</span>).<span style="color:#000">hide</span>();<br />			<span style="color:#708">return</span> <span style="color:#219">false</span>;<br />		});<br />	});<br />&lt;<span style="color:#a11">/script&gt;</span></pre>

4. CSS：参考下吧

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"><span style="color:#a50">/* 访客最近评论 ajax guest comments */</span><br />.<span style="color:#170">guest_comments</span> {<br />    <span style="color:#000">-moz-border-bottom-colors</span>: <span style="color:#164">none</span>;<br />    <span style="color:#000">-moz-border-left-colors</span>: <span style="color:#164">none</span>;<br />    <span style="color:#000">-moz-border-right-colors</span>: <span style="color:#164">none</span>;<br />    <span style="color:#000">-moz-border-top-colors</span>: <span style="color:#164">none</span>;<br />    <span style="color:#000">background</span>: <span style="color:#164">none</span> <span style="color:#164">repeat</span> <span style="color:#164">scroll</span> <span style="color:#164"></span> <span style="color:#164"></span> <span style="color:#219">#fff</span>;<br />    <span style="color:#000">border-color</span>: <span style="color:#219">#e4e5e1</span> <span style="color:#219">#e4e5e1</span> <span style="color:#164">-moz-use-text-color</span>;<br />    <span style="color:#000">border-image</span>: <span style="color:#164">none</span>;<br />    <span style="color:#000">border-style</span>: <span style="color:#164">solid</span> <span style="color:#164">solid</span> <span style="color:#164">none</span>;<br />    <span style="color:#000">border-width</span>: <span style="color:#164">1px</span> <span style="color:#164">1px</span> <span style="color:#164">medium</span>;<br />    <span style="color:#000">bottom</span>: <span style="color:#164"></span>;<br />    <span style="color:#000">left</span>: <span style="color:#164">50%</span>;<br />    <span style="color:#000">line-height</span>: <span style="color:#164">20px</span>;<br />    <span style="color:#000">margin-left</span>: <span style="color:#164">-440px</span>;<br />    <span style="color:#000">max-width</span>: <span style="color:#164">450px</span>;<br />    <span style="color:#000">min-width</span>: <span style="color:#164">169px</span>;<br />    <span style="color:#000">position</span>: <span style="color:#164">fixed</span>;<br />    <span style="color:#000">z-index</span>: <span style="color:#164">9999</span>;<br />}<br />.<span style="color:#170">guest_comments</span> <span style="color:#170">ul</span>{<br />    <span style="color:#000">margin</span>: <span style="color:#164"></span>;<br />    <span style="color:#000">text-align</span>: <span style="color:#164">left</span>;<br />}<br />.<span style="color:#170">guest_info</span> {<br />    <span style="color:#000">padding</span>: <span style="color:#164">5px</span>;<br />    <span style="color:#000">text-align</span>: <span style="color:#164">left</span>;<br />}<br />.<span style="color:#170">guest_info</span> <span style="color:#170">a</span> {<br />    <span style="color:#000">color</span>: <span style="color:#219">#f20</span>;<br />}<br />.<span style="color:#170">guest_info</span> <span style="color:#170">a</span>:<span style="color:#170">hover</span> {<br />    <span style="color:#000">color</span>: <span style="color:#219">#49629e</span>;<br />}<br /><span style="color:#219">#guest_comments_list</span> {<br />    <span style="color:#000">border-top</span>: <span style="color:#164">3px</span> <span style="color:#164">solid</span> <span style="color:#219">#999</span>;<br />    <span style="color:#000">display</span>: <span style="color:#164">none</span>;<br />    <span style="color:#000">max-height</span>: <span style="color:#164">450px</span>;<br />    <span style="color:#000">overflow-y</span>: <span style="color:#164">auto</span>;<br />}<br /><span style="color:#219">#guest_comments_list</span> <span style="color:#170">li</span> {<br />    <span style="color:#000">background</span>: <span style="color:#164">none</span> <span style="color:#164">repeat</span> <span style="color:#164">scroll</span> <span style="color:#164"></span> <span style="color:#164"></span> <span style="color:#219">#f2f2f2</span>;<br />    <span style="color:#000">border-top</span>: <span style="color:#164">1px</span> <span style="color:#164">solid</span> <span style="color:#219">#999</span>;<br />    <span style="color:#000">color</span>: <span style="color:#219">#777</span>;<br />    <span style="color:#000">line-height</span>: <span style="color:#164">20px</span>;<br />    <span style="color:#000">list-style</span>: <span style="color:#164">none</span> <span style="color:#164">outside</span> <span style="color:#164">none</span>;<br />    <span style="color:#000">overflow</span>: <span style="color:#164">hidden</span>;<br />    <span style="color:#000">padding</span>: <span style="color:#164"></span> <span style="color:#164">5px</span>;<br />}<br /><span style="color:#219">#guest_comments_list</span> <span style="color:#170">li</span>:<span style="color:#170">hover</span> {<br />    <span style="color:#000">background</span>: <span style="color:#164">none</span> <span style="color:#164">repeat</span> <span style="color:#164">scroll</span> <span style="color:#164"></span> <span style="color:#164"></span> <span style="color:#219">#fff</span>;<br />}<br /><span style="color:#219">#guest_comments_list</span> <span style="color:#170">li</span> <span style="color:#170">span</span> {<br />    <span style="color:#000">background</span>: <span style="color:#164">none</span> <span style="color:#164">repeat</span> <span style="color:#164">scroll</span> <span style="color:#164"></span> <span style="color:#164"></span> <span style="color:#219">#999</span>;<br />    <span style="color:#000">border-radius</span>: <span style="color:#164"></span> <span style="color:#164"></span> <span style="color:#164">1px</span> <span style="color:#164">1px</span>;<br />    <span style="color:#000">color</span>: <span style="color:#219">#fff</span>;<br />    <span style="color:#000">float</span>: <span style="color:#164">left</span>;<br />    <span style="color:#000">line-height</span>: <span style="color:#164">16px</span>;<br />    <span style="color:#000">margin-right</span>: <span style="color:#164">5px</span>;<br />    <span style="color:#000">padding</span>: <span style="color:#164"></span> <span style="color:#164">4px</span>;<br />}<br /><span style="color:#219">#guest_comments_list</span> <span style="color:#170">li</span>:<span style="color:#170">hover</span> &gt; <span style="color:#170">span</span> {<br />    <span style="color:#000">background</span>: <span style="color:#164">none</span> <span style="color:#164">repeat</span> <span style="color:#164">scroll</span> <span style="color:#164"></span> <span style="color:#164"></span> <span style="color:#219">#8c9fcc</span>;<br />}<br /><span style="color:#219">#guest_comments_list</span> <span style="color:#170">li</span> <span style="color:#170">a</span> {<br />    <span style="color:#000">color</span>: <span style="color:#219">#333</span>;<br />    <span style="color:#000">display</span>: <span style="color:#164">block</span>;<br />    <span style="color:#000">font-size</span>: <span style="color:#164">12px</span>;<br />}<br /><span style="color:#219">#guest_comments_list</span> <span style="color:#170">li</span> <span style="color:#170">a</span>:<span style="color:#170">hover</span> {<br />    <span style="color:#000">color</span>: <span style="color:#219">#49629e</span>;<br />}<br /><span style="color:#219">#gc_close</span> {<br />    <span style="color:#000">background</span>: <span style="color:#164">none</span> <span style="color:#164">repeat</span> <span style="color:#164">scroll</span> <span style="color:#164"></span> <span style="color:#164"></span> <span style="color:#219">#fff</span>;<br />    <span style="color:#000">color</span>: <span style="color:#219">#a80000</span>;<br />    <span style="color:#000">display</span>: <span style="color:#164">none</span>;<br />    <span style="color:#000">font-weight</span>: <span style="color:#164">bold</span>;<br />    <span style="color:#000">height</span>: <span style="color:#164">24px</span>;<br />    <span style="color:#000">line-height</span>: <span style="color:#164">24px</span>;<br />    <span style="color:#000">position</span>: <span style="color:#164">absolute</span>;<br />    <span style="color:#000">right</span>: <span style="color:#164">3px</span>;<br />    <span style="color:#000">text-align</span>: <span style="color:#164">center</span>;<br />    <span style="color:#000">top</span>: <span style="color:#164">3px</span>;<br />    <span style="color:#000">width</span>: <span style="color:#164">24px</span>;<br />}<br /><span style="color:#219">#gc_close</span>:<span style="color:#170">hover</span> {<br />    <span style="color:#000">color</span>: <span style="color:#219">#49629e</span>;<br />}</pre>

这样就可以了。

via zww - http://zww.me/ajax-guest-comments.z-turn