---
title: WordPress新版ajax提交评论
author: 大肥羊
layout: post
permalink: /wordpress-new-ajax-comments.html
categories:
  - 大肥羊转载
tags:
  - wordpress
---
这个是之前<a href="http://fatesinger.com/" target="_blank">大发</a>修改过的新版的ajax评论，好像也是基于Willin Kan版本改的。今天 <a href="/try-qiniu-cdn-acceleration.html/comment-page-1#comment-5048" target="_blank">Betty</a> 问我这里的ajax评论怎么弄的，我把现在用的代码抽出来贴一下。有两种方法：方法一，提交评论后不可以修改；方法二，提交评论后刷新页面前可以重新修改评论内容。  


原文：大发 <a href="http://fatesinger.com/59" target="_blank">http://fatesinger.com/59</a>

<span style = "color:blue;">此方法的优点：</span>防止垃圾评论、增强交互体验、使用wordpress自带的admin-ajax.php进行数据提交、支持评论修改（仅方法二），同时消除了匿名用户可篡改任意评论内容。使用了ajax评论提交我们就可以禁用wordpress的表单提交，也就是删除或者清空wp根目录下的<span style = "color:blue;">wp-comment-post.php</span>这个文件，以防止机器人提交的<a href="https://cyhour.com/wordpress-how-to-effectively-deal-with-spam.html" target="_blank">垃圾评论</a>。

### 前提条件

  * 条件一：先确定自己所用主题的评论列表调用是否使用 WordPress 官方推荐的 wp\_list\_comment() 函数（一般在 comments.php）
  * 条件二：如果“条件一”满足，那么看看 wp\_list\_comment() 有没有加回调函数参数（callback=ooxx），如果有请检查是否跟 WP 官方的回调函数示例类似，这里看 http://codex.wordpress.org/Function\_Reference/wp\_list_comments
  * 条件三：看看评论框是否使用 comment_form() 函数生成，如果不是，请确保html结构差不多，特别是输入框的ID是否为 comment

<span style = "color:red;">方法一：</span>提交评论后不可以修改

一、下载 <a href="/wp-content/uploads/2014/11/comments-ajax-js.zip" target="_blank" rel="attachment wp-att-1279">comments-ajax-js</a> ，<span style = "color:blue;">将 comments-ajax.js 文件里的 http://cyhour.com 替换成你自己的域名</span>，然后把 comments-ajax.js 文件放到<span style = "color:red;">主题目录下的js目录</span>里面。

在主题functions.php里面加载 <span style = "color:red;">jQuery 库</span> 和 comments-ajax.js。

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">if ( is_singular() <span style="color:#219">&& comments_open() && get_option( 'thread_comments' ) ) {</span><br />    wp_enqueue_script('jquery');//如果主题在其他地方加载了 jQuery 库，可以删除此行<br />    wp_enqueue_script('comments-ajax', (get_template_directory_uri()."/js/comments-ajax.js"));<br />    wp_localize_script('comments-ajax', 'ajax_comment_cy', array( "um_ajaxurl" =&gt; admin_url('admin-ajax.php')));<br />}</pre>

二、将下面的代码丢到主题的functions.php文件里面。

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">//新版ajax 评论<br /><br />add_action('wp_ajax_nopriv_ajax_comment', 'ajax_comment');<br />add_action('wp_ajax_ajax_comment', 'ajax_comment');<br />function ajax_comment(){<br />    global $wpdb;<br />    $comment_post_ID = isset($_POST['comment_post_ID']) ? (int) $_POST['comment_post_ID'] : 0;<br />    $post = get_post($comment_post_ID);<br />    if ( empty($post-&gt;comment_status) ) {<br />        do_action('comment_id_not_found', $comment_post_ID);<br />        ajax_comment_err(__('Invalid comment status.'));<br />    }<br />    $status = get_post_status($post);<br />    $status_obj = get_post_status_object($status);<br />    if ( !comments_open($comment_post_ID) ) {<br />        do_action('comment_closed', $comment_post_ID);<br />        ajax_comment_err(__('Sorry, comments are closed for this item.'));<br />    } elseif ( 'trash' == $status ) {<br />        do_action('comment_on_trash', $comment_post_ID);<br />        ajax_comment_err(__('Invalid comment status.'));<br />    } elseif ( !$status_obj-&gt;public <span style="color:#219">&& !$status_obj-&gt;private ) {</span><br />        do_action('comment_on_draft', $comment_post_ID);<br />        ajax_comment_err(__('Invalid comment status.'));<br />    } elseif ( post_password_required($comment_post_ID) ) {<br />        do_action('comment_on_password_protected', $comment_post_ID);<br />        ajax_comment_err(__('Password Protected'));<br />    } else {<br />        do_action('pre_comment_on_post', $comment_post_ID);<br />    }<br />    $comment_author       = ( isset($_POST['author']) )  ? trim(strip_tags($_POST['author'])) : null;<br />    $comment_author_email = ( isset($_POST['email']) )   ? trim($_POST['email']) : null;<br />    $comment_author_url   = ( isset($_POST['url']) )     ? trim($_POST['url']) : null;<br />    $comment_content      = ( isset($_POST['comment']) ) ? trim($_POST['comment']) : null;<br />    $user = wp_get_current_user();<br />    if ( $user-&gt;exists() ) {<br />        if ( empty( $user-&gt;display_name ) )<br />            $user-&gt;display_name=$user-&gt;user_login;<br />        $comment_author       = $wpdb-&gt;escape($user-&gt;display_name);<br />        $comment_author_email = $wpdb-&gt;escape($user-&gt;user_email);<br />        $comment_author_url   = $wpdb-&gt;escape($user-&gt;user_url);<br />        $user_ID              = $wpdb-&gt;escape($user-&gt;ID);<br />        if ( current_user_can('unfiltered_html') ) {<br />            if ( wp_create_nonce('unfiltered-html-comment_' . $comment_post_ID) != $_POST['_wp_unfiltered_html_comment'] ) {<br />                kses_remove_filters();<br />                kses_init_filters();<br />            }<br />        }<br />    } else {<br />        if ( get_option('comment_registration') || 'private' == $status )<br />            ajax_comment_err(__('Sorry, you must be logged in to post a comment.'));<br />    }<br />    $comment_type = '';<br />    if ( get_option('require_name_email') <span style="color:#219">&& !$user-&gt;exists() ) {</span><br />        if ( 6 &gt; strlen($comment_author_email) || '' == $comment_author )<br />            ajax_comment_err( __('Error: please fill the required fields (name, email).') );<br />        elseif ( !is_email($comment_author_email))<br />            ajax_comment_err( __('Error: please enter a valid email address.') );<br />    }<br />    if ( '' == $comment_content )<br />        ajax_comment_err( __('Error: please type a comment.') );<br />    $dupe = "SELECT comment_ID FROM $wpdb-&gt;comments WHERE comment_post_ID = '$comment_post_ID' AND ( comment_author = '$comment_author' ";<br />    if ( $comment_author_email ) $dupe .= "OR comment_author_email = '$comment_author_email' ";<br />    $dupe .= ") AND comment_content = '$comment_content' LIMIT 1";<br />    if ( $wpdb-&gt;get_var($dupe) ) {<br />        ajax_comment_err(__('Duplicate comment detected; it looks as though you<span style="color:#219">&#8217;</span>ve already said that!'));<br />    }<br />    if ( $lasttime = $wpdb-&gt;get_var( $wpdb-&gt;prepare("SELECT comment_date_gmt FROM $wpdb-&gt;comments WHERE comment_author = %s ORDER BY comment_date DESC LIMIT 1", $comment_author) ) ) {<br />        $time_lastcomment = mysql2date('U', $lasttime, false);<br />        $time_newcomment  = mysql2date('U', current_time('mysql', 1), false);<br />        $flood_die = apply_filters('comment_flood_filter', false, $time_lastcomment, $time_newcomment);<br />        if ( $flood_die ) {<br />            ajax_comment_err(__('You are posting comments too quickly.  Slow down.'));<br />        }<br />    }<br />    $comment_parent = isset($_POST['comment_parent']) ? absint($_POST['comment_parent']) : 0;<br />    $commentdata = compact('comment_post_ID', 'comment_author', 'comment_author_email', 'comment_author_url', 'comment_content', 'comment_type', 'comment_parent', 'user_ID');<br /><br />    $comment_id = wp_new_comment( $commentdata );<br /><br />    $comment = get_comment($comment_id);<br />    do_action('set_comment_cookies', $comment, $user);<br />    $comment_depth = 1;<br />    $tmp_c = $comment;<br />    while($tmp_c-&gt;comment_parent != 0){<br />        $comment_depth++;<br />        $tmp_c = get_comment($tmp_c-&gt;comment_parent);<br />    }<br />    $GLOBALS['comment'] = $comment; <br />    ?&gt;<br />    <span style="color:#a50">&lt;!-- Your comments here    edit start --&gt;</span><br />    <span style="color:#170">&lt;li</span> <span style="color:#00c">&lt;</span><span style="color:#00c">?php</span> <span style="color:#00c">comment_class();</span> <span style="color:#00c">?</span><span style="color:#170">&gt;</span> id="li-comment-<span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">comment_ID</span>(); <span style="color:#555">?&gt;</span>"&gt;<br />        <span style="color:#170">&lt;article</span> <span style="color:#00c">id</span>=<span style="color:#a11">"comment-&lt;?php comment_ID(); ?&gt;"</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment"</span><span style="color:#170">&gt;</span><br />            <span style="color:#170">&lt;footer</span><span style="color:#170">&gt;</span><br />                <span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment-author vcard"</span><span style="color:#170">&gt;</span><br />                    <span style="color:#555">&lt;?php</span> <span style="color:#708">echo</span> <span style="color:#@cm-word">get_avatar</span>( <span style="color:#000-2">$comment</span>, <span style="color:#164">40</span> ); <span style="color:#555">?&gt;</span><br />                    <span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">printf</span>( <span style="color:#@cm-word">__</span>( <span style="color:#a11">'%s &lt;span class="says"&gt;says:&lt;/span&gt;'</span>, <span style="color:#a11">'publish'</span> ), <span style="color:#@cm-word">sprintf</span>( <span style="color:#a11">'&lt;cite class="fn"&gt;%s&lt;/cite&gt;'</span>, <span style="color:#@cm-word">get_comment_author_link</span>() ) ); <span style="color:#555">?&gt;</span><br />                    <span style="color:#555">&lt;?php</span> 	<span style="color:#708">if</span> (<span style="color:#@cm-word">function_exists</span>(<span style="color:#a11">"CID_init"</span>)) <span style="color:#@cm-word">CID_print_comment_flag</span>(); <br />							<span style="color:#708">if</span> (<span style="color:#@cm-word">function_exists</span>(<span style="color:#a11">"is_friend_link"</span>)) <span style="color:#@cm-word">is_friend_link</span>(<span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_author_url</span>);<br />					<span style="color:#555">?&gt;</span><br />					<span style="color:#555">&lt;?php</span> <span style="color:#708">if</span>(<span style="color:#@cm-word">user_can</span>(<span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">user_id</span>, <span style="color:#164">1</span>)){ <span style="color:#555">?&gt;</span><span style="color:#170">&lt;i</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment-admin"</span> <span style="color:#00c">title</span>=<span style="color:#a11">"博主"</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/i</span><span style="color:#170">&gt;</span><span style="color:#555">&lt;?php</span> } <span style="color:#555">?&gt;</span><br />                    <span style="color:#555">&lt;?php</span> <span style="color:#708">echo</span> <span style="color:#000-2">$commentcountText</span>; <span style="color:#a50">//主评论楼层号?&gt;</span><br />                <span style="color:#000">&lt;/</span><span style="color:#@cm-word">div</span><span style="color:#000">&gt;&lt;!--</span> .<span style="color:#@cm-word">comment</span><span style="color:#000">-</span><span style="color:#@cm-word">author</span> .<span style="color:#@cm-word">vcard</span> <span style="color:#000">--&gt;</span><br />                <span style="color:#000">&lt;?</span><span style="color:#@cm-word">php</span> <span style="color:#708">if</span> ( <span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_approved</span> <span style="color:#000">==</span> <span style="color:#a11">'0'</span> ) : <span style="color:#555">?&gt;</span><br />                    <span style="color:#170">&lt;em</span><span style="color:#170">&gt;</span><span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">_e</span>( <span style="color:#a11">'Your comment is awaiting moderation.'</span>, <span style="color:#a11">'publish'</span> ); <span style="color:#555">?&gt;</span><span style="color:#170">&lt;/em</span><span style="color:#170">&gt;</span><br />                    <span style="color:#170">&lt;br</span> <span style="color:#170">/&gt;</span><br />                <span style="color:#555">&lt;?php</span> <span style="color:#708">endif</span>; <span style="color:#555">?&gt;</span><br /><br />                <span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment-meta commentmetadata"</span><span style="color:#170">&gt;</span><br />                    <span style="color:#170">&lt;a</span> <span style="color:#00c">href</span>=<span style="color:#a11">"&lt;?php echo esc_url( get_comment_link( $comment-&gt;comment_ID ) ); ?&gt;"</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;time</span> <span style="color:#00c">pubdate</span> <span style="color:#00c">datetime</span>=<span style="color:#a11">"&lt;?php comment_time( 'c' ); ?&gt;"</span><span style="color:#170">&gt;</span><br />                    <span style="color:#555">&lt;?php</span><br />                        <span style="color:#a50">/* translators: 1: date, 2: time */</span><br />                        <span style="color:#@cm-word">printf</span>( <span style="color:#@cm-word">__</span>( <span style="color:#a11">'%1$s at %2$s'</span>, <span style="color:#a11">'publish'</span> ), <span style="color:#@cm-word">get_comment_date</span>(), <span style="color:#@cm-word">get_comment_time</span>() ); <span style="color:#555">?&gt;</span><br />                    <span style="color:#170">&lt;/time</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/a</span><span style="color:#170">&gt;</span><br />                <span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><span style="color:#a50">&lt;!-- .comment-meta .commentmetadata --&gt;</span><br />            <span style="color:#f00">&lt;/footer</span><span style="color:#f00">&gt;</span><br />            <span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment-content"</span><span style="color:#170">&gt;</span><span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">comment_text</span>(); <span style="color:#555">?&gt;</span><span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br />        <span style="color:#f00">&lt;/article</span><span style="color:#f00">&gt;</span><span style="color:#a50">&lt;!-- #comment-## --&gt;</span><br />    <span style="color:#a50">&lt;!-- edit end --&gt;</span><br />    <span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">die</span>();<br /><br />}<br /><span style="color:#708">function</span> <span style="color:#@cm-word">ajax_comment_err</span>(<span style="color:#000-2">$a</span>) {<br />    <span style="color:#@cm-word">header</span>(<span style="color:#a11">'HTTP/1.0 500 Internal Server Error'</span>);<br />    <span style="color:#@cm-word">header</span>(<span style="color:#a11">'Content-Type: text/plain;charset=UTF-8'</span>);<br />    <span style="color:#708">echo</span> <span style="color:#000-2">$a</span>;<br />    <span style="color:#708">exit</span>;<br />}</pre>

然后根据你主题的评论显示输出结构 修改 

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"><span style="color:#a50">&lt;!-- Your comments here    edit start --&gt;</span>  和  <span style="color:#a50">&lt;!-- edit end --&gt;</span></pre>

之间的内容。

<span style = "color:blue;">\---\---\---\---\---\---\----可爱的分割线\---\---\---\---\---\---\-----</span>

<span style = "color:red;">方法二</span>：成功提交评论刷新网页前可以重新修改评论（更新：2014-11-20）

一、下面的代码加到functions.php中，注意<span style = "color:red;">修改成你自己的评论输出样式</span>。

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">add_action('wp_ajax_nopriv_ajax_comment', 'ajax_comment');<br />add_action('wp_ajax_ajax_comment', 'ajax_comment');<br />function ajax_comment(){<br />    global $wpdb;<br />    //nocache_headers();<br />    $comment_post_ID = isset($_POST['comment_post_ID']) ? (int) $_POST['comment_post_ID'] : 0;<br />    $post = get_post($comment_post_ID);<br />    $post_author = $post-&gt;post_author;<br />    if ( empty($post-&gt;comment_status) ) {<br />        do_action('comment_id_not_found', $comment_post_ID);<br />        ajax_comment_err('Invalid comment status.');<br />    }<br />    $status = get_post_status($post);<br />    $status_obj = get_post_status_object($status);<br />    if ( !comments_open($comment_post_ID) ) {<br />        do_action('comment_closed', $comment_post_ID);<br />        ajax_comment_err('Sorry, comments are closed for this item.');<br />    } elseif ( 'trash' == $status ) {<br />        do_action('comment_on_trash', $comment_post_ID);<br />        ajax_comment_err('Invalid comment status.');<br />    } elseif ( !$status_obj-&gt;public <span style="color:#219">&& !$status_obj-&gt;private ) {</span><br />        do_action('comment_on_draft', $comment_post_ID);<br />        ajax_comment_err('Invalid comment status.');<br />    } elseif ( post_password_required($comment_post_ID) ) {<br />        do_action('comment_on_password_protected', $comment_post_ID);<br />        ajax_comment_err('Password Protected');<br />    } else {<br />        do_action('pre_comment_on_post', $comment_post_ID);<br />    }<br />    $comment_author       = ( isset($_POST['author']) )  ? trim(strip_tags($_POST['author'])) : null;<br />    $comment_author_email = ( isset($_POST['email']) )   ? trim($_POST['email']) : null;<br />    $comment_author_url   = ( isset($_POST['url']) )     ? trim($_POST['url']) : null;<br />    $comment_content      = ( isset($_POST['comment']) ) ? trim($_POST['comment']) : null;<br />    $edit_id              = ( isset($_POST['edit_id']) ) ? $_POST['edit_id'] : null; // 提取 edit_id<br />    $user = wp_get_current_user();<br />    if ( $user-&gt;exists() ) {<br />        if ( empty( $user-&gt;display_name ) )<br />            $user-&gt;display_name=$user-&gt;user_login;<br />        $comment_author       = esc_sql($user-&gt;display_name);<br />        $comment_author_email = esc_sql($user-&gt;user_email);<br />        $comment_author_url   = esc_sql($user-&gt;user_url);<br />        $user_ID              = esc_sql($user-&gt;ID);<br />        if ( current_user_can('unfiltered_html') ) {<br />            if ( wp_create_nonce('unfiltered-html-comment_' . $comment_post_ID) != $_POST['_wp_unfiltered_html_comment'] ) {<br />                kses_remove_filters();<br />                kses_init_filters();<br />            }<br />        }<br />    } else {<br />        if ( get_option('comment_registration') || 'private' == $status )<br />            ajax_comment_err('Sorry, you must be logged in to post a comment.');<br />    }<br />    $comment_type = '';<br />    if ( get_option('require_name_email') <span style="color:#219">&& !$user-&gt;exists() ) {</span><br />        if ( 6 &gt; strlen($comment_author_email) || '' == $comment_author )<br />            ajax_comment_err( __('Error: 请填写昵称以及邮箱。') );<br />        elseif ( !is_email($comment_author_email))<br />            ajax_comment_err( __('Error: 请输入一个有效的电子邮箱地址。') );<br />    }<br />    if ( '' == $comment_content )<br />        ajax_comment_err( 'Error: please type a comment.' );<br />    $dupe = "SELECT comment_ID FROM $wpdb-&gt;comments WHERE comment_post_ID = '$comment_post_ID' AND ( comment_author = '$comment_author' ";<br />    if ( $comment_author_email ) $dupe .= "OR comment_author_email = '$comment_author_email' ";<br />    $dupe .= ") AND comment_content = '$comment_content' LIMIT 1";<br />    if ( $wpdb-&gt;get_var($dupe) ) {<br />        ajax_comment_err('Duplicate comment detected; it looks as though you<span style="color:#219">&#8217;</span>ve already said that!');<br />    }<br />    if ( $lasttime = $wpdb-&gt;get_var( $wpdb-&gt;prepare("SELECT comment_date_gmt FROM $wpdb-&gt;comments WHERE comment_author = %s ORDER BY comment_date DESC LIMIT 1", $comment_author) ) ) {<br />        $time_lastcomment = mysql2date('U', $lasttime, false);<br />        $time_newcomment  = mysql2date('U', current_time('mysql', 1), false);<br />        $flood_die = apply_filters('comment_flood_filter', false, $time_lastcomment, $time_newcomment);<br />        if ( $flood_die ) {<br />            ajax_comment_err('You are posting comments too quickly.  Slow down.');<br />        }<br />    }<br />    $comment_parent = isset($_POST['comment_parent']) ? absint($_POST['comment_parent']) : 0;<br />    $commentdata = compact('comment_post_ID', 'comment_author', 'comment_author_email', 'comment_author_url', 'comment_content', 'comment_type', 'comment_parent', 'user_ID');<br />    if ( $edit_id )<br />    {<br />        $comment_id = $commentdata['comment_ID'] = $edit_id;<br />        if( ihacklog_user_can_edit_comment($commentdata,$comment_id) )<br />        {<br />            wp_update_comment( $commentdata );<br />        }<br />        else<br />        {<br />            ajax_comment_err( 'Cheatin<span style="color:#219">&#8217;</span> uh?' );<br />        }<br />    }<br />    else<br />    {<br />        $comment_id = wp_new_comment( $commentdata );<br />    }<br />    $comment = get_comment($comment_id);<br />    do_action('set_comment_cookies', $comment, $user);<br />    $comment_depth = 1;<br />    $tmp_c = $comment;<br />    while($tmp_c-&gt;comment_parent != 0){<br />        $comment_depth++;<br />        $tmp_c = get_comment($tmp_c-&gt;comment_parent);<br />    }<br />    $GLOBALS['comment'] = $comment;<br />    ?&gt;<br />    <span style="color:#a50">&lt;!-- Your comments here  edit start //这里修改成你的评论结构 --&gt;</span><br />    <span style="color:#170">&lt;li</span> <span style="color:#00c">&lt;</span><span style="color:#00c">?php</span> <span style="color:#00c">comment_class();</span> <span style="color:#00c">?</span><span style="color:#170">&gt;</span> id="li-comment-<span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">comment_ID</span>(); <span style="color:#555">?&gt;</span>"&gt;<br />        <span style="color:#170">&lt;article</span> <span style="color:#00c">id</span>=<span style="color:#a11">"comment-&lt;?php comment_ID(); ?&gt;"</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment"</span><span style="color:#170">&gt;</span><br />            <span style="color:#170">&lt;footer</span><span style="color:#170">&gt;</span><br />                <span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment-author vcard"</span><span style="color:#170">&gt;</span><br />                    <span style="color:#555">&lt;?php</span> <span style="color:#708">echo</span> <span style="color:#@cm-word">get_avatar</span>( <span style="color:#000-2">$comment</span>, <span style="color:#164">40</span> ); <span style="color:#555">?&gt;</span><br />                    <span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">printf</span>( <span style="color:#@cm-word">__</span>( <span style="color:#a11">'%s &lt;span class="says"&gt;says:&lt;/span&gt;'</span>, <span style="color:#a11">'publish'</span> ), <span style="color:#@cm-word">sprintf</span>( <span style="color:#a11">'&lt;cite class="fn"&gt;%s&lt;/cite&gt;'</span>, <span style="color:#@cm-word">get_comment_author_link</span>() ) ); <span style="color:#555">?&gt;</span><br />                    <span style="color:#555">&lt;?php</span>   <span style="color:#708">if</span> (<span style="color:#@cm-word">function_exists</span>(<span style="color:#a11">"CID_init"</span>)) <span style="color:#@cm-word">CID_print_comment_flag</span>(); <br />                            <span style="color:#708">if</span> (<span style="color:#@cm-word">function_exists</span>(<span style="color:#a11">"is_friend_link"</span>)) <span style="color:#@cm-word">is_friend_link</span>(<span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_author_url</span>);<br />                    <span style="color:#555">?&gt;</span><br />                    <span style="color:#555">&lt;?php</span> <span style="color:#708">if</span>(<span style="color:#@cm-word">user_can</span>(<span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">user_id</span>, <span style="color:#164">1</span>)){ <span style="color:#555">?&gt;</span><span style="color:#170">&lt;i</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment-admin"</span> <span style="color:#00c">title</span>=<span style="color:#a11">"博主"</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/i</span><span style="color:#170">&gt;</span><span style="color:#555">&lt;?php</span> } <span style="color:#555">?&gt;</span><br />                    <span style="color:#555">&lt;?php</span> <span style="color:#708">echo</span> <span style="color:#000-2">$commentcountText</span>; <span style="color:#a50">//主评论楼层号?&gt;</span><br />                <span style="color:#000">&lt;/</span><span style="color:#@cm-word">div</span><span style="color:#000">&gt;&lt;!--</span> .<span style="color:#@cm-word">comment</span><span style="color:#000">-</span><span style="color:#@cm-word">author</span> .<span style="color:#@cm-word">vcard</span> <span style="color:#000">--&gt;</span><br />                <span style="color:#000">&lt;?</span><span style="color:#@cm-word">php</span> <span style="color:#708">if</span> ( <span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_approved</span> <span style="color:#000">==</span> <span style="color:#a11">'0'</span> ) : <span style="color:#555">?&gt;</span><br />                    <span style="color:#170">&lt;em</span><span style="color:#170">&gt;</span><span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">_e</span>( <span style="color:#a11">'Your comment is awaiting moderation.'</span>, <span style="color:#a11">'publish'</span> ); <span style="color:#555">?&gt;</span><span style="color:#170">&lt;/em</span><span style="color:#170">&gt;</span><br />                    <span style="color:#170">&lt;br</span> <span style="color:#170">/&gt;</span><br />                <span style="color:#555">&lt;?php</span> <span style="color:#708">endif</span>; <span style="color:#555">?&gt;</span><br /><br />                <span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment-meta commentmetadata"</span><span style="color:#170">&gt;</span><br />                    <span style="color:#170">&lt;a</span> <span style="color:#00c">href</span>=<span style="color:#a11">"&lt;?php echo esc_url( get_comment_link( $comment-&gt;comment_ID ) ); ?&gt;"</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;time</span> <span style="color:#00c">pubdate</span> <span style="color:#00c">datetime</span>=<span style="color:#a11">"&lt;?php comment_time( 'c' ); ?&gt;"</span><span style="color:#170">&gt;</span><br />                    <span style="color:#555">&lt;?php</span><br />                        <span style="color:#a50">/* translators: 1: date, 2: time */</span><br />                        <span style="color:#@cm-word">printf</span>( <span style="color:#@cm-word">__</span>( <span style="color:#a11">'%1$s at %2$s'</span>, <span style="color:#a11">'publish'</span> ), <span style="color:#@cm-word">get_comment_date</span>(), <span style="color:#@cm-word">get_comment_time</span>() ); <span style="color:#555">?&gt;</span><br />                    <span style="color:#170">&lt;/time</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/a</span><span style="color:#170">&gt;</span><br />                <span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><span style="color:#a50">&lt;!-- .comment-meta .commentmetadata --&gt;</span><br />            <span style="color:#f00">&lt;/footer</span><span style="color:#f00">&gt;</span><br />            <span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"comment-content"</span><span style="color:#170">&gt;</span><span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">comment_text</span>(); <span style="color:#555">?&gt;</span><span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br />        <span style="color:#f00">&lt;/article</span><span style="color:#f00">&gt;</span><span style="color:#a50">&lt;!-- #comment-## --&gt;</span><br />    <span style="color:#a50">&lt;!-- edit end --&gt;</span><br />    <span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">die</span>();<br />}<br /><span style="color:#708">function</span> <span style="color:#@cm-word">ajax_comment_err</span>(<span style="color:#000-2">$a</span>) {<br />    <span style="color:#@cm-word">header</span>(<span style="color:#a11">'HTTP/1.0 500 Internal Server Error'</span>);<br />    <span style="color:#@cm-word">header</span>(<span style="color:#a11">'Content-Type: text/plain;charset=UTF-8'</span>);<br />    <span style="color:#708">echo</span> <span style="color:#000-2">$a</span>;<br />    <span style="color:#708">exit</span>;<br />}<br /><span style="color:#708">function</span> <span style="color:#@cm-word">ihacklog_user_can_edit_comment</span>(<span style="color:#000-2">$new_cmt_data</span>,<span style="color:#000-2">$comment_ID</span> <span style="color:#000">=</span> <span style="color:#164"></span>) {<br />    <span style="color:#708">if</span>(<span style="color:#@cm-word">current_user_can</span>(<span style="color:#a11">'edit_comment'</span>, <span style="color:#000-2">$comment_ID</span>)) {<br />        <span style="color:#@cm-word">return</span> <span style="color:#219">true</span>;<br />    }<br />    <span style="color:#000-2">$comment</span> <span style="color:#000">=</span> <span style="color:#@cm-word">get_comment</span>( <span style="color:#000-2">$comment_ID</span> );<br />    <span style="color:#000-2">$old_timestamp</span> <span style="color:#000">=</span> <span style="color:#@cm-word">strtotime</span>( <span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_date</span>);<br />    <span style="color:#000-2">$new_timestamp</span> <span style="color:#000">=</span> <span style="color:#@cm-word">current_time</span>(<span style="color:#a11">'timestamp'</span>);<br />    <span style="color:#a50">// 不用get_comment_author_email($comment_ID) , get_comment_author_IP($comment_ID)</span><br />    <span style="color:#000-2">$rs</span> <span style="color:#000">=</span> <span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_author_email</span> <span style="color:#000">===</span> <span style="color:#000-2">$new_cmt_data</span>[<span style="color:#a11">'comment_author_email'</span>]<br />        <span style="color:#000">&&</span> <span style="color:#000-2">$comment</span><span style="color:#000">-&gt;</span><span style="color:#@cm-word">comment_author_IP</span> <span style="color:#000">===</span> <span style="color:#000-2">$_SERVER</span>[<span style="color:#a11">'REMOTE_ADDR'</span>]<br />        <span style="color:#000">&&</span> <span style="color:#000-2">$new_timestamp</span> <span style="color:#000">-</span> <span style="color:#000-2">$old_timestamp</span> <span style="color:#000">&lt;</span> <span style="color:#164">3600</span>;<br />    <span style="color:#@cm-word">return</span> <span style="color:#000-2">$rs</span>;<br />}</pre>

根据你主题的评论显示输出结构修改 

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"><span style="color:#a50">&lt;!-- Your comments here    edit start --&gt;</span>  和  <span style="color:#a50">&lt;!-- edit end --&gt;</span></pre>

之间的内容。

二、JS 代码，<span style = "color:red;">注意将里面的 http://cyhour.com 替换成你的网址</span>。

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"><span style="color:#a50">/**</span><br /> <span style="color:#a50">* jQuery-Ajax-Comments by Bigfa.http://fatesinger.com/59</span><br /> <span style="color:#a50">*/</span><br /><span style="color:#000">jQuery</span>(<span style="color:#000">document</span>).<span style="color:#000">ready</span>(<span style="color:#708">function</span>(<span style="color:#00f">jQuery</span>) {<br />    <span style="color:#708">var</span> <span style="color:#00f">jQuerycommentform</span> = <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#commentform'</span>),<br />    <span style="color:#00f">txt1</span> = <span style="color:#a11">'&lt;div id="loading"&gt;&lt;img src="https://cyhour.com/wp-admin/images/wpspin_light.gif" style="vertical-align:middle;" alt=""/&gt;  正在提交, 请稍候...&lt;/div&gt;'</span>,<br />    <span style="color:#00f">txt2</span> = <span style="color:#a11">'&lt;div id="error"&gt;#&lt;/div&gt;'</span>,<br />    <span style="color:#00f">txt3</span> = <span style="color:#a11">'"&gt;&lt;img src="https://cyhour.com/wp-admin/images/yes.png" style="vertical-align:middle;" alt=""/&gt; 评论提交成功'</span>,<br />    <span style="color:#00f">edt1</span> = <span style="color:#a11">', 刷新页面之前您可以&lt;a rel="nofollow" class="comment-reply-link" href="#edit" onclick='return addComment.moveForm("'</span>,<br />    <span style="color:#00f">edt2</span> = <span style="color:#a11">')'&gt;点击这里修改评论&lt;/a&gt;'</span>,<br />    <span style="color:#00f">cancel_edit</span> = <span style="color:#a11">'取消编辑'</span>,<br />    <span style="color:#00f">edit</span>,<br />    <span style="color:#00f">num</span> = <span style="color:#164">1</span>,<br />    <span style="color:#00f">jQuerycomments</span> = <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#comments-title'</span>),<br />    <span style="color:#00f">jQuerycancel</span> = <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#cancel-comment-reply-link'</span>),<br />    <span style="color:#00f">cancel_text</span> = <span style="color:#000-2">jQuerycancel</span>.<span style="color:#000">text</span>(),<br />    <span style="color:#00f">jQuerysubmit</span> = <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#commentform #submit'</span>);<br />    <span style="color:#000-2">jQuerysubmit</span>.<span style="color:#000">attr</span>(<span style="color:#a11">'disabled'</span>, <span style="color:#219">false</span>),<br />    <span style="color:#000">jQuerybody</span> = (<span style="color:#000">window</span>.<span style="color:#000">opera</span>) ? (<span style="color:#000">document</span>.<span style="color:#000">compatMode</span> == <span style="color:#a11">"CSS1Compat"</span> ? <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'html'</span>) : <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'body'</span>)) : <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'html,body'</span>),<br />    <span style="color:#000">comm_array</span> = [];<br />    <span style="color:#000">comm_array</span>.<span style="color:#000">push</span>(<span style="color:#a11">''</span>);<br />    <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#comment'</span>).<span style="color:#000">after</span>(<span style="color:#000-2">txt1</span> + <span style="color:#000-2">txt2</span>);<br />    <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#loading'</span>).<span style="color:#000">hide</span>();<br />    <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#error'</span>).<span style="color:#000">hide</span>();<br />    <span style="color:#000-2">jQuery</span>(<span style="color:#000">document</span>).<span style="color:#000">on</span>(<span style="color:#a11">"submit"</span>, <span style="color:#a11">"#commentform"</span>,<br />    <span style="color:#708">function</span>() {<br />        <span style="color:#708">if</span> (<span style="color:#000-2">edit</span>) <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#comment'</span>).<span style="color:#000">after</span>(<span style="color:#a11">'&lt;input type="text" name="edit_id" id="edit_id" value="'</span> + <span style="color:#000-2">edit</span> + <span style="color:#a11">'" style="display:none;" /&gt;'</span>);<br />        <span style="color:#000">editcode</span>();<br />        <span style="color:#000-2">jQuerysubmit</span>.<span style="color:#000">attr</span>(<span style="color:#a11">'disabled'</span>, <span style="color:#219">true</span>).<span style="color:#000">fadeTo</span>(<span style="color:#a11">'slow'</span>, <span style="color:#164">0.5</span>);<br />        <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#loading'</span>).<span style="color:#000">slideDown</span>();<br />        <span style="color:#000-2">jQuery</span>.<span style="color:#000">ajax</span>({<br />            <span style="color:#000">url</span>: <span style="color:#a11">'https://cyhour.com/wp-admin/admin-ajax.php'</span>,<br />            <span style="color:#000">data</span>: <span style="color:#000-2">jQuery</span>(<span style="color:#000-2">this</span>).<span style="color:#000">serialize</span>() + <span style="color:#a11">"&action=ajax_comment"</span>,<br />            <span style="color:#000">type</span>: <span style="color:#000-2">jQuery</span>(<span style="color:#000-2">this</span>).<span style="color:#000">attr</span>(<span style="color:#a11">'method'</span>),<br />            <span style="color:#000">error</span>: <span style="color:#708">function</span>(<span style="color:#00f">request</span>) {<br />                <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#loading'</span>).<span style="color:#000">hide</span>();<br />                <span style="color:#000-2">jQuery</span>(<span style="color:#a11">"#error"</span>).<span style="color:#000">slideDown</span>().<span style="color:#000">html</span>(<span style="color:#000-2">request</span>.<span style="color:#000">responseText</span>);<br />                <span style="color:#000">setTimeout</span>(<span style="color:#708">function</span>() {<br />                    <span style="color:#000-2">jQuerysubmit</span>.<span style="color:#000">attr</span>(<span style="color:#a11">'disabled'</span>, <span style="color:#219">false</span>).<span style="color:#000">fadeTo</span>(<span style="color:#a11">'slow'</span>, <span style="color:#164">1</span>);<br />                    <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#error'</span>).<span style="color:#000">slideUp</span>();<br />                },<br />                <span style="color:#164">3000</span>);<br />            },<br />            <span style="color:#000">success</span>: <span style="color:#708">function</span>(<span style="color:#00f">data</span>) {<br />                <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#loading'</span>).<span style="color:#000">hide</span>();<br />                <span style="color:#000">comm_array</span>.<span style="color:#000">push</span>(<span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#comment'</span>).<span style="color:#000">val</span>());<br />                <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'textarea'</span>).<span style="color:#000">each</span>(<span style="color:#708">function</span>() {<br />                    <span style="color:#000-2">this</span>.<span style="color:#000">value</span> = <span style="color:#a11">''</span><br />                });<br />                <span style="color:#708">var</span> <span style="color:#00f">t</span> = <span style="color:#000">addComment</span>,<br />                <span style="color:#00f">cancel</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'cancel-comment-reply-link'</span>),<br />                <span style="color:#00f">temp</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'wp-temp-form-div'</span>),<br />                <span style="color:#00f">respond</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#000-2">t</span>.<span style="color:#000">respondId</span>),<br />                <span style="color:#00f">post</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_post_ID'</span>).<span style="color:#000">value</span>,<br />                <span style="color:#00f">parent</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_parent'</span>).<span style="color:#000">value</span>;<br />                <span style="color:#708">if</span> (!<span style="color:#000-2">edit</span> && <span style="color:#000-2">jQuerycomments</span>.<span style="color:#000">length</span>) {<br />                    <span style="color:#000">n</span> = <span style="color:#000">parseInt</span>(<span style="color:#000-2">jQuerycomments</span>.<span style="color:#000">text</span>().<span style="color:#000">match</span>(<span style="color:#a11">/d+/</span>));<br />                    <span style="color:#000-2">jQuerycomments</span>.<span style="color:#000">text</span>(<span style="color:#000-2">jQuerycomments</span>.<span style="color:#000">text</span>().<span style="color:#000">replace</span>(<span style="color:#000">n</span>, <span style="color:#000">n</span> + <span style="color:#164">1</span>));<br />                }<br />                <span style="color:#000">new_htm</span> = <span style="color:#a11">'" id="new_comm_'</span> + <span style="color:#000-2">num</span> + <span style="color:#a11">'"&gt;&lt;/'</span>;<br />                <span style="color:#000">new_htm</span> = (<span style="color:#000-2">parent</span> == <span style="color:#a11">'0'</span>) ? (<span style="color:#a11">'n&lt;ol style="clear:both;" class="commentlist'</span> + <span style="color:#000">new_htm</span> + <span style="color:#a11">'ol&gt;'</span>) : (<span style="color:#a11">'n&lt;ul class="children'</span> + <span style="color:#000">new_htm</span> + <span style="color:#a11">'ul&gt;'</span>);<br />                <span style="color:#000">ok_htm</span> = <span style="color:#a11">'n&lt;div class="ajax-notice" id="success_'</span> + <span style="color:#000-2">num</span> + <span style="color:#000-2">txt3</span>;<br />                <span style="color:#000">div_</span> = (<span style="color:#000">document</span>.<span style="color:#000">body</span>.<span style="color:#000">innerHTML</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">'div-comment-'</span>) == -<span style="color:#164">1</span>) ? <span style="color:#a11">''</span>: ((<span style="color:#000">document</span>.<span style="color:#000">body</span>.<span style="color:#000">innerHTML</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">'li-comment-'</span>) == -<span style="color:#164">1</span>) ? <span style="color:#a11">'div-'</span>: <span style="color:#a11">''</span>);<br />                <span style="color:#000">ok_htm</span> = <span style="color:#000">ok_htm</span>.<span style="color:#000">concat</span>(<span style="color:#000-2">edt1</span>, <span style="color:#000">div_</span>, <span style="color:#a11">'comment-'</span>, <span style="color:#000-2">parent</span>, <span style="color:#a11">'", "'</span>, <span style="color:#000-2">parent</span>, <span style="color:#a11">'", "respond", "'</span>, <span style="color:#000-2">post</span>, <span style="color:#a11">'", '</span>, <span style="color:#000-2">num</span>, <span style="color:#000-2">edt2</span>);<br />                <span style="color:#000">ok_htm</span> += <span style="color:#a11">'&lt;/span&gt;&lt;span&gt;&lt;/span&gt;n'</span>;<br />                <span style="color:#000">ok_htm</span> += <span style="color:#a11">'&lt;/div&gt;n'</span>;<br />                <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#respond'</span>).<span style="color:#000">before</span>(<span style="color:#000">new_htm</span>);<br />                <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#new_comm_'</span> + <span style="color:#000-2">num</span>).<span style="color:#000">append</span>(<span style="color:#000-2">data</span>);<br />                <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#new_comm_'</span> + <span style="color:#000-2">num</span> + <span style="color:#a11">' li'</span>).<span style="color:#000">append</span>(<span style="color:#000">ok_htm</span>);<br />                <span style="color:#000">jQuerybody</span>.<span style="color:#000">animate</span>({<br />                    <span style="color:#000">scrollTop</span>: <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#new_comm_'</span> + <span style="color:#000-2">num</span>).<span style="color:#000">offset</span>().<span style="color:#000">top</span> - <span style="color:#164">200</span><br />                },<br />                <span style="color:#164">900</span>);<br />                <span style="color:#000">countdown</span>();<br />                <span style="color:#000-2">num</span>++;<br />                <span style="color:#000-2">edit</span> = <span style="color:#a11">''</span>;<br />                <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'*'</span>).<span style="color:#000">remove</span>(<span style="color:#a11">'#edit_id'</span>);<br />                <span style="color:#000-2">cancel</span>.<span style="color:#000">style</span>.<span style="color:#000">display</span> = <span style="color:#a11">'none'</span>;<br />                <span style="color:#000-2">cancel</span>.<span style="color:#000">onclick</span> = <span style="color:#219">null</span>;<br />                <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_parent'</span>).<span style="color:#000">value</span> = <span style="color:#a11">'0'</span>;<br />                <span style="color:#708">if</span> (<span style="color:#000-2">temp</span> && <span style="color:#000-2">respond</span>) {<br />                    <span style="color:#000-2">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">insertBefore</span>(<span style="color:#000-2">respond</span>, <span style="color:#000-2">temp</span>);<br />                    <span style="color:#000-2">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">removeChild</span>(<span style="color:#000-2">temp</span>)<br />                }<br />            }<br />        });<br />        <span style="color:#708">return</span> <span style="color:#219">false</span>;<br />    });<br />    <span style="color:#000">addComment</span> = {<br />        <span style="color:#000">moveForm</span>: <span style="color:#708">function</span>(<span style="color:#00f">commId</span>, <span style="color:#00f">parentId</span>, <span style="color:#00f">respondId</span>, <span style="color:#00f">postId</span>, <span style="color:#00f">num</span>) {<br />            <span style="color:#708">var</span> <span style="color:#00f">t</span> = <span style="color:#000-2">this</span>,<br />            <span style="color:#00f">div</span>,<br />            <span style="color:#00f">comm</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#000-2">commId</span>),<br />            <span style="color:#00f">respond</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#000-2">respondId</span>),<br />            <span style="color:#00f">cancel</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'cancel-comment-reply-link'</span>),<br />            <span style="color:#00f">parent</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_parent'</span>),<br />            <span style="color:#00f">post</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_post_ID'</span>);<br />            <span style="color:#708">if</span> (<span style="color:#000-2">edit</span>) <span style="color:#000">exit_prev_edit</span>();<br />            <span style="color:#000-2">num</span> ? (<span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment'</span>).<span style="color:#000">value</span> = <span style="color:#000">comm_array</span>[<span style="color:#000-2">num</span>], <span style="color:#000-2">edit</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'new_comm_'</span> + <span style="color:#000-2">num</span>).<span style="color:#000">innerHTML</span>.<span style="color:#000">match</span>(<span style="color:#a11">/(comment-)(d+)/</span>)[<span style="color:#164">2</span>], <span style="color:#000">jQuerynew_sucs</span> = <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#success_'</span> + <span style="color:#000-2">num</span>), <span style="color:#000">jQuerynew_sucs</span>.<span style="color:#000">hide</span>(), <span style="color:#000">jQuerynew_comm</span> = <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#new_comm_'</span> + <span style="color:#000-2">num</span>), <span style="color:#000">jQuerynew_comm</span>.<span style="color:#000">hide</span>(), <span style="color:#000-2">jQuerycancel</span>.<span style="color:#000">text</span>(<span style="color:#000-2">cancel_edit</span>)) : <span style="color:#000-2">jQuerycancel</span>.<span style="color:#000">text</span>(<span style="color:#000-2">cancel_text</span>);<br />            <span style="color:#000-2">t</span>.<span style="color:#000">respondId</span> = <span style="color:#000-2">respondId</span>;<br />            <span style="color:#000-2">postId</span> = <span style="color:#000-2">postId</span> || <span style="color:#219">false</span>;<br />            <span style="color:#708">if</span> (!<span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'wp-temp-form-div'</span>)) {<br />                <span style="color:#000-2">div</span> = <span style="color:#000">document</span>.<span style="color:#000">createElement</span>(<span style="color:#a11">'div'</span>);<br />                <span style="color:#000-2">div</span>.<span style="color:#000">id</span> = <span style="color:#a11">'wp-temp-form-div'</span>;<br />                <span style="color:#000-2">div</span>.<span style="color:#000">style</span>.<span style="color:#000">display</span> = <span style="color:#a11">'none'</span>;<br />                <span style="color:#000-2">respond</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">insertBefore</span>(<span style="color:#000-2">div</span>, <span style="color:#000-2">respond</span>)<br />            } ! <span style="color:#000-2">comm</span> ? (<span style="color:#000">temp</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'wp-temp-form-div'</span>), <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_parent'</span>).<span style="color:#000">value</span> = <span style="color:#a11">'0'</span>, <span style="color:#000">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">insertBefore</span>(<span style="color:#000-2">respond</span>, <span style="color:#000">temp</span>), <span style="color:#000">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">removeChild</span>(<span style="color:#000">temp</span>)) : <span style="color:#000-2">comm</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">insertBefore</span>(<span style="color:#000-2">respond</span>, <span style="color:#000-2">comm</span>.<span style="color:#000">nextSibling</span>);<br />            <span style="color:#000">jQuerybody</span>.<span style="color:#000">animate</span>({<br />                <span style="color:#000">scrollTop</span>: <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'#respond'</span>).<span style="color:#000">offset</span>().<span style="color:#000">top</span> - <span style="color:#164">180</span><br />            },<br />            <span style="color:#164">400</span>);<br />            <span style="color:#708">if</span> (<span style="color:#000-2">post</span> && <span style="color:#000-2">postId</span>) <span style="color:#000-2">post</span>.<span style="color:#000">value</span> = <span style="color:#000-2">postId</span>;<br />            <span style="color:#000-2">parent</span>.<span style="color:#000">value</span> = <span style="color:#000-2">parentId</span>;<br />            <span style="color:#000-2">cancel</span>.<span style="color:#000">style</span>.<span style="color:#000">display</span> = <span style="color:#a11">''</span>;<br />            <span style="color:#000-2">cancel</span>.<span style="color:#000">onclick</span> = <span style="color:#708">function</span>() {<br />                <span style="color:#708">if</span> (<span style="color:#000-2">edit</span>) <span style="color:#000">exit_prev_edit</span>();<br />                <span style="color:#708">var</span> <span style="color:#00f">t</span> = <span style="color:#000">addComment</span>,<br />                <span style="color:#00f">temp</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'wp-temp-form-div'</span>),<br />                <span style="color:#00f">respond</span> = <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#000-2">t</span>.<span style="color:#000">respondId</span>);<br />                <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment_parent'</span>).<span style="color:#000">value</span> = <span style="color:#a11">'0'</span>;<br />                <span style="color:#708">if</span> (<span style="color:#000-2">temp</span> && <span style="color:#000-2">respond</span>) {<br />                    <span style="color:#000-2">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">insertBefore</span>(<span style="color:#000-2">respond</span>, <span style="color:#000-2">temp</span>);<br />                    <span style="color:#000-2">temp</span>.<span style="color:#000">parentNode</span>.<span style="color:#000">removeChild</span>(<span style="color:#000-2">temp</span>);<br />                }<br />                <span style="color:#000-2">this</span>.<span style="color:#000">style</span>.<span style="color:#000">display</span> = <span style="color:#a11">'none'</span>;<br />                <span style="color:#000-2">this</span>.<span style="color:#000">onclick</span> = <span style="color:#219">null</span>;<br />                <span style="color:#708">return</span> <span style="color:#219">false</span>;<br />            };<br />            <span style="color:#708">try</span> {<br />                <span style="color:#000-2">t</span>.<span style="color:#000">I</span>(<span style="color:#a11">'comment'</span>).<span style="color:#000">focus</span>();<br />            }<br />             <span style="color:#708">catch</span>(<span style="color:#00f">e</span>) {}<br />            <span style="color:#708">return</span> <span style="color:#219">false</span>;<br />        },<br />        <span style="color:#000">I</span>: <span style="color:#708">function</span>(<span style="color:#00f">e</span>) {<br />            <span style="color:#708">return</span> <span style="color:#000">document</span>.<span style="color:#000">getElementById</span>(<span style="color:#000-2">e</span>);<br />        }<br />    };<br />    <span style="color:#708">function</span> <span style="color:#00f">exit_prev_edit</span>() {<br />        <span style="color:#000">jQuerynew_comm</span>.<span style="color:#000">show</span>();<br />        <span style="color:#000">jQuerynew_sucs</span>.<span style="color:#000">show</span>();<br />        <span style="color:#000-2">jQuery</span>(<span style="color:#a11">'textarea'</span>).<span style="color:#000">each</span>(<span style="color:#708">function</span>() {<br />            <span style="color:#000-2">this</span>.<span style="color:#000">value</span> = <span style="color:#a11">''</span><br />        });<br />        <span style="color:#000-2">edit</span> = <span style="color:#a11">''</span>;<br />    }<br />    <span style="color:#708">var</span> <span style="color:#00f">wait</span> = <span style="color:#164">15</span>,<br />    <span style="color:#00f">submit_val</span> = <span style="color:#000-2">jQuerysubmit</span>.<span style="color:#000">val</span>();<br />    <span style="color:#708">function</span> <span style="color:#00f">countdown</span>() {<br />        <span style="color:#708">if</span> (<span style="color:#000-2">wait</span> &gt; <span style="color:#164"></span>) {<br />            <span style="color:#000-2">jQuerysubmit</span>.<span style="color:#000">val</span>(<span style="color:#000-2">wait</span>);<br />            <span style="color:#000-2">wait</span>--;<br />            <span style="color:#000">setTimeout</span>(<span style="color:#000-2">countdown</span>, <span style="color:#164">1000</span>);<br />        } <span style="color:#708">else</span> {<br />            <span style="color:#000-2">jQuerysubmit</span>.<span style="color:#000">val</span>(<span style="color:#000-2">submit_val</span>).<span style="color:#000">attr</span>(<span style="color:#a11">'disabled'</span>, <span style="color:#219">false</span>).<span style="color:#000">fadeTo</span>(<span style="color:#a11">'slow'</span>, <span style="color:#164">1</span>);<br />            <span style="color:#000-2">wait</span> = <span style="color:#164">15</span>;<br />        }<br />    }<br />    <span style="color:#708">function</span> <span style="color:#00f">editcode</span>() {<br />        <span style="color:#708">var</span> <span style="color:#00f">a</span> = <span style="color:#a11">""</span>,<br />        <span style="color:#00f">b</span> = <span style="color:#000-2">jQuery</span>(<span style="color:#a11">"#comment"</span>).<span style="color:#000">val</span>(),<br />        <span style="color:#00f">start</span> = <span style="color:#000-2">b</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">"&lt;code&gt;"</span>),<br />        <span style="color:#00f">end</span> = <span style="color:#000-2">b</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">"&lt;/code&gt;"</span>);<br />        <span style="color:#708">if</span> (<span style="color:#000-2">start</span> &gt; -<span style="color:#164">1</span> && <span style="color:#000-2">end</span> &gt; -<span style="color:#164">1</span> && <span style="color:#000-2">start</span> &lt; <span style="color:#000-2">end</span>) {<br />            <span style="color:#000-2">a</span> = <span style="color:#a11">""</span>;<br />            <span style="color:#708">while</span> (<span style="color:#000-2">end</span> != -<span style="color:#164">1</span>) {<br />                <span style="color:#000-2">a</span> += <span style="color:#000-2">b</span>.<span style="color:#000">substring</span>(<span style="color:#164"></span>, <span style="color:#000-2">start</span> + <span style="color:#164">6</span>) + <span style="color:#000-2">b</span>.<span style="color:#000">substring</span>(<span style="color:#000-2">start</span> + <span style="color:#164">6</span>, <span style="color:#000-2">end</span>).<span style="color:#000">replace</span>(<span style="color:#a11">/&lt;(?=[^&gt;]*?&gt;)/gi</span>, <span style="color:#a11">"&lt;"</span>).<span style="color:#000">replace</span>(<span style="color:#a11">/&gt;/gi</span>, <span style="color:#a11">"&gt;"</span>);<br />                <span style="color:#000-2">b</span> = <span style="color:#000-2">b</span>.<span style="color:#000">substring</span>(<span style="color:#000-2">end</span> + <span style="color:#164">7</span>, <span style="color:#000-2">b</span>.<span style="color:#000">length</span>);<br />                <span style="color:#000-2">start</span> = <span style="color:#000-2">b</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">"&lt;code&gt;"</span>) == -<span style="color:#164">1</span> ? -<span style="color:#164">6</span>: <span style="color:#000-2">b</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">"&lt;code&gt;"</span>);<br />                <span style="color:#000-2">end</span> = <span style="color:#000-2">b</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">"&lt;/code&gt;"</span>);<br />                <span style="color:#708">if</span> (<span style="color:#000-2">end</span> == -<span style="color:#164">1</span>) {<br />                    <span style="color:#000-2">a</span> += <span style="color:#a11">"&lt;/code&gt;"</span> + <span style="color:#000-2">b</span>;<br />                    <span style="color:#000-2">jQuery</span>(<span style="color:#a11">"#comment"</span>).<span style="color:#000">val</span>(<span style="color:#000-2">a</span>)<br />                } <span style="color:#708">else</span> <span style="color:#708">if</span> (<span style="color:#000-2">start</span> == -<span style="color:#164">6</span>) {<br />                    <span style="color:#000">myFielde</span> += <span style="color:#a11">"&lt;/code&gt;"</span><br />                } <span style="color:#708">else</span> {<br />                    <span style="color:#000-2">a</span> += <span style="color:#a11">"&lt;/code&gt;"</span><br />                }<br />            }<br />        }<br />        <span style="color:#708">var</span> <span style="color:#00f">b</span> = <span style="color:#000-2">a</span> ? <span style="color:#000-2">a</span>: <span style="color:#000-2">jQuery</span>(<span style="color:#a11">"#comment"</span>).<span style="color:#000">val</span>(),<br />        <span style="color:#000-2">a</span> = <span style="color:#a11">""</span>,<br />        <span style="color:#000-2">start</span> = <span style="color:#000-2">b</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">"&lt;pre&gt;"</span>),<br />        <span style="color:#000-2">end</span> = <span style="color:#000-2">b</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">"&lt;/pre&gt;"</span>);<br />        <span style="color:#708">if</span> (<span style="color:#000-2">start</span> &gt; -<span style="color:#164">1</span> && <span style="color:#000-2">end</span> &gt; -<span style="color:#164">1</span> && <span style="color:#000-2">start</span> &lt; <span style="color:#000-2">end</span>) {<br />            <span style="color:#000-2">a</span> = <span style="color:#000-2">a</span><br />        } <span style="color:#708">else</span> <span style="color:#708">return</span>;<br />        <span style="color:#708">while</span> (<span style="color:#000-2">end</span> != -<span style="color:#164">1</span>) {<br />            <span style="color:#000-2">a</span> += <span style="color:#000-2">b</span>.<span style="color:#000">substring</span>(<span style="color:#164"></span>, <span style="color:#000-2">start</span> + <span style="color:#164">5</span>) + <span style="color:#000-2">b</span>.<span style="color:#000">substring</span>(<span style="color:#000-2">start</span> + <span style="color:#164">5</span>, <span style="color:#000-2">end</span>).<span style="color:#000">replace</span>(<span style="color:#a11">/&lt;(?=[^&gt;]*?&gt;)/gi</span>, <span style="color:#a11">"&lt;"</span>).<span style="color:#000">replace</span>(<span style="color:#a11">/&gt;/gi</span>, <span style="color:#a11">"&gt;"</span>);<br />            <span style="color:#000-2">b</span> = <span style="color:#000-2">b</span>.<span style="color:#000">substring</span>(<span style="color:#000-2">end</span> + <span style="color:#164">6</span>, <span style="color:#000-2">b</span>.<span style="color:#000">length</span>);<br />            <span style="color:#000-2">start</span> = <span style="color:#000-2">b</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">"&lt;pre&gt;"</span>) == -<span style="color:#164">1</span> ? -<span style="color:#164">5</span>: <span style="color:#000-2">b</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">"&lt;pre&gt;"</span>);<br />            <span style="color:#000-2">end</span> = <span style="color:#000-2">b</span>.<span style="color:#000">indexOf</span>(<span style="color:#a11">"&lt;/pre&gt;"</span>);<br />            <span style="color:#708">if</span> (<span style="color:#000-2">end</span> == -<span style="color:#164">1</span>) {<br />                <span style="color:#000-2">a</span> += <span style="color:#a11">"&lt;/pre&gt;"</span> + <span style="color:#000-2">b</span>;<br />                <span style="color:#000-2">jQuery</span>(<span style="color:#a11">"#comment"</span>).<span style="color:#000">val</span>(<span style="color:#000-2">a</span>)<br />            } <span style="color:#708">else</span> <span style="color:#708">if</span> (<span style="color:#000-2">start</span> == -<span style="color:#164">5</span>) {<br />                <span style="color:#000">myFielde</span> += <span style="color:#a11">"&lt;/pre&gt;"</span><br />            } <span style="color:#708">else</span> {<br />                <span style="color:#000-2">a</span> += <span style="color:#a11">"&lt;/pre&gt;"</span><br />            }<br />        }<br />    }<br />    <span style="color:#708">function</span> <span style="color:#00f">grin</span>(<span style="color:#00f">a</span>) {<br />        <span style="color:#708">var</span> <span style="color:#00f">b</span>;<br />        <span style="color:#000-2">a</span> = <span style="color:#a11">" "</span> + <span style="color:#000-2">a</span> + <span style="color:#a11">" "</span>;<br />        <span style="color:#708">if</span> (<span style="color:#000">document</span>.<span style="color:#000">getElementById</span>(<span style="color:#a11">"comment"</span>) && <span style="color:#000">document</span>.<span style="color:#000">getElementById</span>(<span style="color:#a11">"comment"</span>).<span style="color:#000">type</span> == <span style="color:#a11">"textarea"</span>) {<br />            <span style="color:#000-2">b</span> = <span style="color:#000">document</span>.<span style="color:#000">getElementById</span>(<span style="color:#a11">"comment"</span>)<br />        } <span style="color:#708">else</span> {<br />            <span style="color:#708">return</span> <span style="color:#219">false</span><br />        }<br />        <span style="color:#708">if</span> (<span style="color:#000">document</span>.<span style="color:#000">selection</span>) {<br />            <span style="color:#000-2">b</span>.<span style="color:#000">focus</span>();<br />            <span style="color:#000">sel</span> = <span style="color:#000">document</span>.<span style="color:#000">selection</span>.<span style="color:#000">createRange</span>();<br />            <span style="color:#000">sel</span>.<span style="color:#000">text</span> = <span style="color:#000-2">a</span>;<br />            <span style="color:#000-2">b</span>.<span style="color:#000">focus</span>()<br />        } <span style="color:#708">else</span> <span style="color:#708">if</span> (<span style="color:#000-2">b</span>.<span style="color:#000">selectionStart</span> || <span style="color:#000-2">b</span>.<span style="color:#000">selectionStart</span> == <span style="color:#a11">"0"</span>) {<br />            <span style="color:#708">var</span> <span style="color:#00f">c</span> = <span style="color:#000-2">b</span>.<span style="color:#000">selectionStart</span>;<br />            <span style="color:#708">var</span> <span style="color:#00f">d</span> = <span style="color:#000-2">b</span>.<span style="color:#000">selectionEnd</span>;<br />            <span style="color:#708">var</span> <span style="color:#00f">e</span> = <span style="color:#000-2">d</span>;<br />            <span style="color:#000-2">b</span>.<span style="color:#000">value</span> = <span style="color:#000-2">b</span>.<span style="color:#000">value</span>.<span style="color:#000">substring</span>(<span style="color:#164"></span>, <span style="color:#000-2">c</span>) + <span style="color:#000-2">a</span> + <span style="color:#000-2">b</span>.<span style="color:#000">value</span>.<span style="color:#000">substring</span>(<span style="color:#000-2">d</span>, <span style="color:#000-2">b</span>.<span style="color:#000">value</span>.<span style="color:#000">length</span>);<br />            <span style="color:#000-2">e</span> += <span style="color:#000-2">a</span>.<span style="color:#000">length</span>;<br />            <span style="color:#000-2">b</span>.<span style="color:#000">focus</span>();<br />            <span style="color:#000-2">b</span>.<span style="color:#000">selectionStart</span> = <span style="color:#000-2">e</span>;<br />            <span style="color:#000-2">b</span>.<span style="color:#000">selectionEnd</span> = <span style="color:#000-2">e</span><br />        } <span style="color:#708">else</span> {<br />            <span style="color:#000-2">b</span>.<span style="color:#000">value</span> += <span style="color:#000-2">a</span>;<br />            <span style="color:#000-2">b</span>.<span style="color:#000">focus</span>()<br />        }<br />    }<br />});</pre>

将 js代码保存为 comments-ajax.js 文件，放到主题目录下的js目录里面。然后在主题functions.php里面加载 <span style = "color:red;">jQuery 库</span> 和 comments-ajax.js即可。

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">if ( is_singular() <span style="color:#219">&& comments_open() && get_option( 'thread_comments' ) ) {</span><br />    wp_enqueue_script('jquery');//如果主题在其他地方加载了 jQuery 库，可以删除此行<br />    wp_enqueue_script('comments-ajax', (get_template_directory_uri()."/js/comments-ajax.js"));<br />}</pre>

<span style = "color:red;">Lastupdate：20141127</span>——表达能力不好，此前的<a href="https://cyhour.com/wordpress-new-ajax-comments.html/comment-page-1#comment-4808" target="_blank">内容比较混乱</a>，现在将两种方法稍作区分；另外之前没说需要加载 jQuery 库，现补上。